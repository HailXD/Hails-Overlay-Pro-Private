/* @preserve
// ==UserScript==
// @name         Hail's OP
// @namespace    http://tampermonkey.net/
// @version      2.8.12
// @author       shinkonet (Altered by Hail)
// @match        https://wplace.live/*
// @license      GPLv3
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM.setValue
// @grant        GM.getValue
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @connect      *
// @run-at       document-start
// @updateURL    https://github.com/HailXD/wplace-d/raw/refs/heads/main/overlay.user.js
// @downloadURL  https://github.com/HailXD/wplace-d/raw/refs/heads/main/overlay.user.js
// ==/UserScript==
@endpreserve */
!function(){"use strict";const e=1e3,t=1e3,o=window.fetch;function a(e){return new Promise(((t,o)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=o,a.readAsDataURL(e)}))}async function n(e){const t=await function(e){return new Promise(((t,o)=>{try{GM_xmlhttpRequest({method:"GET",url:e,responseType:"blob",onload:e=>{e.status>=200&&e.status<300&&e.response?t(e.response):o(new Error(`GM_xhr failed: ${e.status} ${e.statusText}`))},onerror:()=>o(new Error("GM_xhr network error")),ontimeout:()=>o(new Error("GM_xhr timeout"))})}catch(e){o(e)}}))}(e);if(!t||!String(t.type).startsWith("image/"))throw new Error("URL did not return an image blob");return await a(t)}const i=[[0,0,0],[60,60,60],[120,120,120],[210,210,210],[255,255,255],[96,0,24],[237,28,36],[255,127,39],[246,170,9],[249,221,59],[255,250,188],[14,185,104],[19,230,123],[135,255,94],[12,129,110],[16,174,166],[19,225,190],[96,247,242],[40,80,158],[64,147,228],[107,80,246],[153,177,251],[120,12,153],[170,56,185],[224,159,249],[203,0,122],[236,31,128],[243,141,169],[104,70,52],[149,104,42],[248,178,119]],r=[[170,170,170],[165,14,30],[250,128,114],[228,92,26],[156,132,49],[197,173,49],[232,212,95],[74,107,58],[90,148,74],[132,197,115],[15,121,159],[187,250,242],[125,199,255],[77,49,184],[74,66,132],[122,113,196],[181,174,241],[155,82,73],[209,128,120],[250,182,164],[219,164,99],[123,99,82],[156,132,107],[214,181,148],[209,128,81],[255,197,165],[109,100,63],[148,140,107],[205,197,158],[51,57,65],[109,117,141],[179,185,209]],l={"0,0,0":"Black","60,60,60":"Dark Gray","120,120,120":"Gray","210,210,210":"Light Gray","255,255,255":"White","96,0,24":"Deep Red","237,28,36":"Red","255,127,39":"Orange","246,170,9":"Gold","249,221,59":"Yellow","255,250,188":"Light Yellow","14,185,104":"Dark Green","19,230,123":"Green","135,255,94":"Light Green","12,129,110":"Dark Teal","16,174,166":"Teal","19,225,190":"Light Teal","96,247,242":"Cyan","40,80,158":"Dark Blue","64,147,228":"Blue","107,80,246":"Indigo","153,177,251":"Light Indigo","120,12,153":"Dark Purple","170,56,185":"Purple","224,159,249":"Light Purple","203,0,122":"Dark Pink","236,31,128":"Pink","243,141,169":"Light Pink","104,70,52":"Dark Brown","149,104,42":"Brown","248,178,119":"Beige","170,170,170":"Medium Gray","165,14,30":"Dark Red","250,128,114":"Light Red","228,92,26":"Dark Orange","156,132,49":"Dark Goldenrod","197,173,49":"Goldenrod","232,212,95":"Light Goldenrod","74,107,58":"Dark Olive","90,148,74":"Olive","132,197,115":"Light Olive","15,121,159":"Dark Cyan","187,250,242":"Light Cyan","125,199,255":"Light Blue","77,49,184":"Dark Indigo","74,66,132":"Dark Slate Blue","122,113,196":"Slate Blue","181,174,241":"Light Slate Blue","155,82,73":"Dark Peach","209,128,120":"Peach","250,182,164":"Light Peach","219,164,99":"Light Brown","123,99,82":"Dark Tan","156,132,107":"Tan","214,181,148":"Light Tan","209,128,81":"Dark Beige","255,197,165":"Light Beige","109,100,63":"Dark Stone","148,140,107":"Stone","205,197,158":"Light Stone","51,57,65":"Dark Slate","109,117,141":"Slate","179,185,209":"Light Slate"},s=i.map((([e,t,o])=>`${e},${t},${o}`)),c=[];class d extends Map{constructor(e){super(),this.limit=e}set(e,t){if(this.size>=this.limit){const e=this.keys().next().value;this.delete(e)}return super.set(e,t)}}const p=unsafeWindow;function u(){return`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}function g(e){const t=new Set(N.overlays.map((e=>(e.name||"").toLowerCase())));if(!t.has(e.toLowerCase()))return e;let o=1;for(;t.has(`${e} (${o})`.toLowerCase());)o++;return`${e} (${o})`}function m(e,t){if("undefined"!=typeof OffscreenCanvas)return new OffscreenCanvas(e,t);const o=document.createElement("canvas");return o.width=e,o.height=t,o}function v(e,t){const o=document.createElement("canvas");return o.width=e,o.height=t,o}function h(e){return e.convertToBlob?e.convertToBlob():new Promise(((t,o)=>e.toBlob((e=>e?t(e):o(new Error("toBlob failed"))),"image/png")))}async function f(e){if(e&&"function"==typeof e.toDataURL)return e.toDataURL("image/png");if(e&&"function"==typeof e.convertToBlob){const t=await e.convertToBlob();return await a(t)}if("undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas){const t=e.transferToImageBitmap?.();if(t){const o=v(e.width,e.height);return o.getContext("2d").drawImage(t,0,0),o.toDataURL("image/png")}}throw new Error("Cannot export canvas to data URL")}async function b(e){if("function"==typeof createImageBitmap)try{return await createImageBitmap(e)}catch{}return new Promise(((t,o)=>{const a=URL.createObjectURL(e),n=new Image;n.onload=()=>{URL.revokeObjectURL(a),t(n)},n.onerror=e=>{URL.revokeObjectURL(a),o(e)},n.src=a}))}async function y(e){if(!e.imageBase64)return null;if(null==e.visibleColorKeys)return await x(e.imageBase64);const t=e.visibleColorKeys.slice().sort().join(","),o=`${e.imageBase64.slice(0,64)+":"+e.imageBase64.length}|${t}`;if(E.has(o))return E.get(o);const a=await x(e.imageBase64),n=a.width,i=a.height,r=m(n,i),l=r.getContext("2d",{willReadFrequently:!0});l.drawImage(a,0,0);const s=l.getImageData(0,0,n,i),c=s.data,d=new Set(e.visibleColorKeys);for(let e=0;e<c.length;e+=4)if(c[e+3]>0){const t=`${c[e]},${c[e+1]},${c[e+2]}`;d.has(t)||(c[e+3]=0)}l.putImageData(s,0,0);const p=await("function"==typeof createImageBitmap?createImageBitmap(r):x(await f(r)));return E.set(o,p),p}function x(e){return L.has(e)?Promise.resolve(L.get(e)):new Promise(((t,o)=>{const a=new Image;a.crossOrigin="anonymous",a.onload=()=>{L.set(e,a),t(a)},a.onerror=o,a.src=e}))}function w(e){try{const t=new URL(e),o=t.pathname.split("/"),a=new URLSearchParams(t.search);return{chunk1:parseInt(o[3],10),chunk2:parseInt(o[4],10),posX:parseInt(a.get("x")||"0",10),posY:parseInt(a.get("y")||"0",10)}}catch{return{chunk1:0,chunk2:0,posX:0,posY:0}}}function k(e,t,o,a,n,i,r,l){const s=Math.max(e,n),c=Math.max(t,i),d=Math.min(e+o,n+r),p=Math.min(t+a,i+l);return{x:s,y:c,w:Math.max(0,d-s),h:Math.max(0,p-c)}}const C=new d(50),M=new Set,L=new d(50),E=new d(50),S=new d(200),$=new d(200);function I(e){return[e.imageBase64?e.imageBase64.slice(0,64)+":"+e.imageBase64.length:"none",e.pixelUrl||"null",e.offsetX,e.offsetY,e.opacity].join("|")}function R(){C.clear(),L.clear(),E.clear(),S.clear(),$.clear()}async function B(o,a,n){if(!o.enabled||!o.imageBase64||!o.pixelUrl)return null;if(M.has(o.id))return null;const i=I(o),r=`${o.id}|${i}|${a}|${n}`;if(C.has(r))return C.get(r);const l=await y(o);if(!l)return null;const s=l.width,c=l.height;if(s>=t||c>=t)return M.add(o.id),F(`Overlay "${o.name}" skipped: image too large (must be smaller than 1000√ó1000; got ${s}√ó${c}).`),null;const d=w(o.pixelUrl);if(!Number.isFinite(d.chunk1)||!Number.isFinite(d.chunk2))return null;const p=d.chunk1*e+d.posX+o.offsetX-a*e,u=d.chunk2*e+d.posY+o.offsetY-n*e,g=k(0,0,e,e,p,u,s,c);if(0===g.w||0===g.h)return C.set(r,null),null;const v=m(e,e).getContext("2d",{willReadFrequently:!0});v.drawImage(l,p,u);const h=v.getImageData(g.x,g.y,g.w,g.h),f="smart"===N.overlayMode?new Uint8ClampedArray(h.data):null,b=h.data,x=o.opacity,L=255*(1-x);for(let e=0;e<b.length;e+=4)b[e+3]>0&&(N.highlightPixels?(b[e]=255,b[e+1]=0,b[e+2]=255):(b[e]=Math.round(b[e]*x+L),b[e+1]=Math.round(b[e+1]*x+L),b[e+2]=Math.round(b[e+2]*x+L)),b[e+3]=255);const E={imageData:h,dx:g.x,dy:g.y,rawData:f};return C.set(r,E),E}async function P(o,a,n){if(!o.enabled||!o.imageBase64||!o.pixelUrl)return null;if(M.has(o.id))return null;const i=I(o),r=`${o.id}|${i}|minify|s3|${a}|${n}`;if(C.has(r))return C.get(r);const l=await y(o);if(!l)return null;const s=l.width,c=l.height;if(s>=t||c>=t)return M.add(o.id),F(`Overlay "${o.name}" skipped: image too large (must be smaller than 1000√ó1000; got ${s}√ó${c}).`),null;const d=w(o.pixelUrl);if(!Number.isFinite(d.chunk1)||!Number.isFinite(d.chunk2))return null;const p=d.chunk1*e+d.posX+o.offsetX-a*e,u=d.chunk2*e+d.posY+o.offsetY-n*e,g=3e3,v=3e3,h=Math.round(3*p),f=Math.round(3*u),b=3*s,x=3*c,L=k(0,0,g,v,h,f,b,x);if(0===L.w||0===L.h)return C.set(r,null),null;const E=m(g,v).getContext("2d",{willReadFrequently:!0});E.imageSmoothingEnabled=!1,E.clearRect(0,0,g,v),E.drawImage(l,0,0,s,c,h,f,b,x);const S=E.getImageData(L.x,L.y,L.w,L.h),$=S.data,R=o.opacity,B=255*(1-R),P=Math.floor(1.5),D=L.w;for(let e=0;e<$.length;e+=4){if(0===$[e+3])continue;const t=e/4%D,o=Math.floor(e/4/D),a=L.x+t,n=L.y+o;a%3===P&&n%3===P?(N.highlightPixels?($[e]=255,$[e+1]=0,$[e+2]=255):($[e]=Math.round($[e]*R+B),$[e+1]=Math.round($[e+1]*R+B),$[e+2]=Math.round($[e+2]*R+B)),$[e+3]=255):($[e]=0,$[e+1]=0,$[e+2]=0,$[e+3]=0)}const O={imageData:S,dx:L.x,dy:L.y,scaled:!0,scale:3};return C.set(r,O),O}function F(e,t=3e3){let o=document.getElementById("op-toast-stack");o||(o=document.createElement("div"),o.className="op-toast-stack",o.id="op-toast-stack",document.body.appendChild(o)),o.classList.toggle("op-dark","dark"===N.theme);const a=document.createElement("div");a.className="op-toast",a.textContent=e,o.appendChild(a),requestAnimationFrame((()=>a.classList.add("show"))),setTimeout((()=>{a.classList.remove("show"),setTimeout((()=>a.remove()),200)}),t)}let D=!1;function O(){!function(){const e=N.overlays.some((e=>e.enabled&&e.imageBase64)),t=!!N.autoCapturePixelUrl&&!!N.activeOverlayId;return("behind"===N.overlayMode||"above"===N.overlayMode||"smart"===N.overlayMode||"diff"===N.overlayMode||"minify"===N.overlayMode)&&(e||t)&&N.overlays.length>0}()?function(){if(!D)return;p.fetch=o,window.fetch=o,D=!1}():function(){if(D)return;const e=o,t=async(t,o)=>{const a="string"==typeof t?t:t&&t.url||"";if(N.autoCapturePixelUrl&&N.activeOverlayId){const e=function(e){try{const t=new URL(e,location.href);if("backend.wplace.live"!==t.hostname)return null;const o=t.pathname.match(/\/s0\/pixel\/(\d+)\/(\d+)$/);if(!o)return null;const a=t.searchParams;return{normalized:`https://backend.wplace.live/s0/pixel/${o[1]}/${o[2]}?x=${a.get("x")||0}&y=${a.get("y")||0}`}}catch{return null}}(a);if(e){const t=N.overlays.find((e=>e.id===N.activeOverlayId));if(t){if(t.pixelUrl!==e.normalized){t.pixelUrl=e.normalized,t.offsetX=0,t.offsetY=0,await Y(["overlays"]),R(),N.autoCapturePixelUrl=!1,await Y(["autoCapturePixelUrl"]),j();const o=w(t.pixelUrl);F(`Anchor set for "${t.name}": chunk ${o.chunk1}/${o.chunk2} at (${o.posX}, ${o.posY}). Offset reset to (0,0).`),O()}}}}const n=function(e){try{const t=new URL(e,location.href);if("backend.wplace.live"!==t.hostname||!t.pathname.startsWith("/files/"))return null;const o=t.pathname.match(/\/(\d+)\/(\d+)\.png$/i);return o?{chunk1:parseInt(o[1],10),chunk2:parseInt(o[2],10)}:null}catch{return null}}(a);if(!n||!["behind","above","smart","diff","minify"].includes(N.overlayMode))return e(t,o);try{const a=await e(t,o);if(!a.ok)return a;if(!(a.headers.get("Content-Type")||"").toLowerCase().includes("image"))return a;const i=N.overlays.filter((e=>e.enabled&&e.imageBase64&&e.pixelUrl));if(0===i.length)return a;const r=await a.blob();try{const e=await async function(e){const t=await b(e),o=m(t.width,t.height).getContext("2d");return o.drawImage(t,0,0),o.getImageData(0,0,t.width,t.height)}(r.slice()),t=`${n.chunk1},${n.chunk2}`;S.set(t,e),_()}catch(e){}if(r.size>15728640)return a;let l;if("minify"===N.overlayMode){const e=[];for(const t of i)e.push(await P(t,n.chunk1,n.chunk2));l=await async function(e,t){if(!t||0===t.length)return e;const o=await b(e),a=o.width,n=o.height,i=m(3*a,3*n),r=i.getContext("2d",{willReadFrequently:!0});r.imageSmoothingEnabled=!1,r.drawImage(o,0,0,3*a,3*n);for(const e of t){if(!e)continue;const t=e.imageData.width,o=e.imageData.height;if(0===t||0===o)continue;const a=m(t,o);a.getContext("2d",{willReadFrequently:!0}).putImageData(e.imageData,0,0),r.drawImage(a,e.dx,e.dy)}return await h(i)}(r,e.filter(Boolean))}else{const e=[];for(const t of i)e.push(await B(t,n.chunk1,n.chunk2));l="smart"===N.overlayMode?await async function(e,t){if(!t||0===t.length)return e;const o=await b(e),a=o.width,n=o.height,i=m(a,n),r=i.getContext("2d",{willReadFrequently:!0});r.drawImage(o,0,0);const l=r.getImageData(0,0,a,n),s=l.data,c=new Uint32Array(s.buffer);for(const e of t){if(!e||!e.rawData)continue;const t=e.rawData,o=e.imageData.data,i=e.imageData.width,r=e.imageData.height,l=new Uint32Array(t.buffer),s=new Uint32Array(o.buffer);for(let o=0;o<r;o++){const r=e.dy+o;if(!(r<0||r>=n))for(let n=0;n<i;n++){const d=e.dx+n;if(!(d<0||d>=a)&&t[4*(o*i+n)+3]>0){const e=r*a+d,t=o*i+n;l[t]!==c[e]&&(c[e]=s[t])}}}}return r.putImageData(l,0,0),await h(i)}(r,e.filter(Boolean)):"diff"===N.overlayMode?await async function(e,t){if(!t||0===t.length)return e;const o=await b(e),a=o.width,n=o.height,i=m(a,n),r=i.getContext("2d",{willReadFrequently:!0});r.drawImage(o,0,0);const l=r.getImageData(0,0,a,n),s=l.data,c=new Uint32Array(s.buffer);for(const e of t){if(!e||!e.rawData)continue;const t=e.rawData,o=e.imageData.data,i=e.imageData.width,r=e.imageData.height,l=new Uint32Array(t.buffer),d=new Uint32Array(o.buffer);for(let o=0;o<r;o++){const r=e.dy+o;if(!(r<0||r>=n))for(let n=0;n<i;n++){const p=e.dx+n;if(!(p<0||p>=a)&&t[4*(o*i+n)+3]>0){const e=r*a+p,t=e,u=o*i+n;s[4*e+3]>0&&l[u]!==c[t]&&(c[t]=d[u])}}}}return r.putImageData(l,0,0),await h(i)}(r,e.filter(Boolean)):await("behind"===N.overlayMode?async function(e,t){if(!t||0===t.length)return e;const o=await b(e),a=m(o.width,o.height),n=a.getContext("2d");for(const e of t)e&&n.putImageData(e.imageData,e.dx,e.dy);return n.drawImage(o,0,0),await h(a)}(r,e.filter(Boolean)):async function(e,t){if(!t||0===t.length)return e;const o=await b(e),a=m(o.width,o.height),n=a.getContext("2d");n.drawImage(o,0,0);for(const e of t){if(!e)continue;if(!e.imageData||0===e.imageData.width||0===e.imageData.height)continue;const t=m(e.imageData.width,e.imageData.height);t.getContext("2d").putImageData(e.imageData,0,0),n.drawImage(t,e.dx,e.dy)}return await h(a)}(r,e.filter(Boolean)))}const s=new Headers(a.headers);return s.set("Content-Type","image/png"),s.delete("Content-Length"),new Response(l,{status:a.status,statusText:a.statusText,headers:s})}catch(a){return e(t,o)}};p.fetch=t,window.fetch=t,D=!0}()}const N={overlays:[],activeOverlayId:null,overlayMode:"behind",isPanelCollapsed:!1,autoCapturePixelUrl:!1,panelX:null,panelY:null,theme:"light",collapseList:!1,collapseEditor:!1,collapseNudge:!1,collapseColors:!1,highlightPixels:!1,ccFreeKeys:s.slice(),ccPaidKeys:c.slice(),ccZoom:1,ccRealtime:!1},z=Object.keys(N);async function q(){try{await Promise.all(z.map((async e=>{N[e]=await((e,t)=>{try{if("undefined"!=typeof GM&&"function"==typeof GM.getValue)return GM.getValue(e,t);if("function"==typeof GM_getValue)return Promise.resolve(GM_getValue(e,t))}catch{}return Promise.resolve(t)})(e,N[e])}))),Array.isArray(N.ccFreeKeys)&&0!==N.ccFreeKeys.length||(N.ccFreeKeys=s.slice()),Array.isArray(N.ccPaidKeys)||(N.ccPaidKeys=c.slice()),(!Number.isFinite(N.ccZoom)||N.ccZoom<=0)&&(N.ccZoom=1),"boolean"!=typeof N.ccRealtime&&(N.ccRealtime=!1)}catch(e){}}async function Y(e=z){try{await Promise.all(e.map((e=>((e,t)=>{try{if("undefined"!=typeof GM&&"function"==typeof GM.setValue)return GM.setValue(e,t);if("function"==typeof GM_setValue)return Promise.resolve(GM_setValue(e,t))}catch{}return Promise.resolve()})(e,N[e]))))}catch(e){}}function U(){if(document.getElementById("overlay-pro-panel"))return;const e=document.createElement("div");e.id="overlay-pro-panel";const o=Math.max(12,window.innerWidth-340-80);e.style.left=(Number.isFinite(N.panelX)?N.panelX:o)+"px",e.style.top=(Number.isFinite(N.panelY)?N.panelY:120)+"px",e.innerHTML='\n      <div class="op-header" id="op-header">\n          <h3>Hail\'s OP</h3>\n          <div class="op-header-actions">\n              <button class="op-hdr-btn" id="op-theme-toggle" title="Toggle theme">‚òÄÔ∏è/üåô</button>\n              <button class="op-hdr-btn" id="op-refresh-btn" title="Refresh">‚ü≤</button>\n              <button class="op-toggle-btn" id="op-panel-toggle" title="Collapse">‚ñæ</button>\n          </div>\n      </div>\n      <div class="op-content" id="op-content">\n          <div class="op-column">\n              <div class="op-section">\n                  <div class="op-row space">\n                      <select class="op-select" id="op-mode-select" style="flex: 1;">\n                          <option value="behind" style="color: cyan;">Overlay Behind</option>\n                          <option value="above">Overlay Above</option>\n                          <option value="smart">Smart</option>\n                          <option value="diff" style="color: red;">Diff</option>\n                          <option value="minify">Minified</option>\n                          <option value="original">Original</option>\n                      </select>\n                      <div class="op-row">\n                          <span class="op-muted" id="op-place-label">Place overlay:</span>\n                          <button class="op-button" id="op-autocap-toggle" title="Capture next clicked pixel as anchor">OFF</button>\n                      </div>\n                  </div>\n                  <div class="op-row" style="padding: 4px 0;">\n                      <input type="checkbox" id="op-highlight-toggle" style="margin-left: 4px;">\n                      <label for="op-highlight-toggle" style="cursor:pointer;">Highlight pixels (pink)</label>\n                  </div>\n              </div>\n              <div class="op-section">\n                  <div class="op-section-title">\n                      <div class="op-title-left">\n                          <span class="op-title-text">Overlays</span>\n                      </div>\n                      <div class="op-title-right">\n                          <div class="op-row">\n                              <button class="op-button" id="op-add-overlay" title="Create a new overlay">+ Add</button>\n                              <button class="op-button" id="op-import-overlay" title="Import overlay JSON">Import</button>\n                              <button class="op-button" id="op-export-overlay" title="Export active overlay JSON">Export</button>\n                              <button class="op-chevron" id="op-collapse-list" title="Collapse/Expand">‚ñæ</button>\n                          </div>\n                      </div>\n                  </div>\n                  <div id="op-list-wrap">\n                      <div class="op-list" id="op-overlay-list"></div>\n                  </div>\n              </div>\n              <div class="op-section" id="op-editor-section">\n                  <div class="op-section-title">\n                      <div class="op-title-left">\n                          <span class="op-title-text">Editor</span>\n                      </div>\n                      <div class="op-title-right">\n                          <button class="op-chevron" id="op-collapse-editor" title="Collapse/Expand">‚ñæ</button>\n                      </div>\n                  </div>\n                  <div id="op-editor-body">\n                      <div class="op-row">\n                          <label style="width: 90px;">Name</label>\n                          <input type="text" class="op-input op-grow" id="op-name">\n                      </div>\n                      <div id="op-image-source">\n                          <div class="op-row">\n                              <label style="width: 90px;">Image</label>\n                              <input type="text" class="op-input op-grow" id="op-image-url" placeholder="Paste a direct image link">\n                              <button class="op-button" id="op-fetch">Fetch</button>\n                          </div>\n                          <div class="op-preview" id="op-dropzone">\n                              <div class="op-drop-hint">Drop here or click to browse.</div>\n                              <input type="file" id="op-file-input" accept="image/*" style="display:none">\n                          </div>\n                      </div>\n                      <div class="op-preview" id="op-preview-wrap" style="display:none;">\n                          <img id="op-image-preview" alt="No image">\n                      </div>\n                      <div class="op-row" id="op-cc-btn-row" style="display:none; justify-content:space-between; gap:8px; flex-wrap:wrap;">\n                          <button class="op-button" id="op-download-overlay" title="Download this overlay image">Download</button>\n                          <button class="op-button" id="op-open-resize" title="Resize the overlay image">Resize</button>\n                          <button class="op-button" id="op-open-cc" title="Match colors to Wplace palette">Color Match</button>\n                      </div>\n                      <div class="op-row"><span class="op-muted" id="op-coord-display"></span></div>\n                      <div class="op-row" style="width: 100%; gap: 12px; padding: 6px 0;">\n                          <label style="width: 60px;">Opacity</label>\n                          <input type="range" min="0" max="1" step="0.05" class="op-slider op-grow" id="op-opacity-slider">\n                          <span id="op-opacity-value" style="width: 36px; text-align: right;">70%</span>\n                      </div>\n                  </div>\n              </div>\n              <div class="op-section" id="op-nudge-section">\n                  <div class="op-section-title">\n                      <div class="op-title-left">\n                          <span class="op-title-text">Nudge overlay</span>\n                      </div>\n                      <div class="op-title-right">\n                          <span class="op-muted" id="op-offset-indicator">Offset X 0, Y 0</span>\n                          <button class="op-chevron" id="op-collapse-nudge" title="Collapse/Expand">‚ñæ</button>\n                      </div>\n                  </div>\n                  <div id="op-nudge-body">\n                      <div class="op-nudge-row" style="text-align: right;">\n                          <button class="op-icon-btn" id="op-nudge-left" title="Left">‚Üê</button>\n                          <button class="op-icon-btn" id="op-nudge-down" title="Down">‚Üì</button>\n                          <button class="op-icon-btn" id="op-nudge-up" title="Up">‚Üë</button>\n                          <button class="op-icon-btn" id="op-nudge-right" title="Right">‚Üí</button>\n                      </div>\n                  </div>\n              </div>\n          </div>\n          <div class="op-column">\n              <div class="op-section" id="op-colors-section" style="flex-grow: 1;">\n                  <div class="op-section-title">\n                      <div class="op-title-left">\n                          <span class="op-title-text">Color Toggle</span>\n                      </div>\n                      <div class="op-title-right">\n                           <button class="op-button" id="op-colors-refresh" title="Refresh counts" style="padding: 2px 6px; font-size: 12px;">Refresh</button>\n                          <button class="op-chevron" id="op-collapse-colors" title="Collapse/Expand">‚ñæ</button>\n                      </div>\n                  </div>\n                  <div id="op-colors-body">\n                      <div class="op-row" style="gap: 6px; flex-wrap: wrap;">\n                          <button class="op-button" id="op-colors-all">All</button>\n                          <button class="op-button" id="op-colors-none">None</button>\n                          <button class="op-button" id="op-colors-free">All Free</button>\n                          <button class="op-button" id="op-colors-paid">All Paid</button>\n                          <button class="op-button" id="op-colors-copy">Copy</button>\n                      </div>\n                      <div class="op-list" id="op-colors-list" style="max-height: 480px; gap: 4px;"></div>\n                  </div>\n              </div>\n          </div>\n      </div>\n    ',document.body.appendChild(e),function(){const e=document.createElement("div");e.className="op-cc-backdrop",e.id="op-cc-backdrop",document.body.appendChild(e);const o=document.createElement("div");o.className="op-cc-modal",o.id="op-cc-modal",o.style.display="none",o.innerHTML='\n      <div class="op-cc-header" id="op-cc-header">\n        <div class="op-cc-title">Color Match</div>\n        <div class="op-row" style="gap:6px;">\n          <button class="op-button op-cc-pill" id="op-cc-realtime">Realtime: OFF</button>\n          <button class="op-cc-close" id="op-cc-close" title="Close">‚úï</button>\n        </div>\n      </div>\n\n      <div class="op-cc-body">\n        <div class="op-cc-preview-wrap" style="grid-area: preview;">\n          <canvas id="op-cc-preview" class="op-cc-canvas"></canvas>\n          <div class="op-cc-zoom">\n            <button class="op-icon-btn" id="op-cc-zoom-out" title="Zoom out">‚àí</button>\n            <button class="op-icon-btn" id="op-cc-zoom-in" title="Zoom in">+</button>\n          </div>\n        </div>\n\n        <div class="op-cc-controls" style="grid-area: controls;">\n          <div class="op-cc-palette" id="op-cc-free">\n            <div class="op-row space">\n              <label>Free Colors</label>\n              <button class="op-button" id="op-cc-free-toggle">Unselect All</button>\n            </div>\n            <div id="op-cc-free-grid" class="op-cc-grid"></div>\n          </div>\n\n          <div class="op-cc-palette" id="op-cc-paid">\n            <div class="op-row space">\n              <label>Paid Colors (2000üíßeach)</label>\n              <button class="op-button" id="op-cc-paid-toggle">Select All</button>\n            </div>\n            <div id="op-cc-paid-grid" class="op-cc-grid"></div>\n          </div>\n\n          <div class="op-cc-block">\n            <label>Color Counts</label>\n            <div id="op-cc-color-list" class="op-list op-list-subtle" style="max-height: 160px;"></div>\n          </div>\n        </div>\n      </div>\n\n      <div class="op-cc-footer">\n        <div class="op-cc-ghost" id="op-cc-meta"></div>\n        <div class="op-cc-actions">\n          <button class="op-button" id="op-cc-recalc" title="Recalculate color mapping">Calculate</button>\n          <button class="op-button" id="op-cc-apply" title="Apply changes to overlay">Apply</button>\n          <button class="op-button" id="op-cc-cancel" title="Close without saving">Cancel</button>\n        </div>\n      </div>\n    ',document.body.appendChild(o),o.querySelector("#op-cc-close").addEventListener("click",V),e.addEventListener("click",V),o.querySelector("#op-cc-cancel").addEventListener("click",V),Z={backdrop:e,modal:o,previewCanvas:o.querySelector("#op-cc-preview"),previewCtx:o.querySelector("#op-cc-preview").getContext("2d",{willReadFrequently:!0}),sourceCanvas:null,sourceCtx:null,sourceImageData:null,processedCanvas:null,processedCtx:null,freeGrid:o.querySelector("#op-cc-free-grid"),paidGrid:o.querySelector("#op-cc-paid-grid"),freeToggle:o.querySelector("#op-cc-free-toggle"),paidToggle:o.querySelector("#op-cc-paid-toggle"),meta:o.querySelector("#op-cc-meta"),applyBtn:o.querySelector("#op-cc-apply"),recalcBtn:o.querySelector("#op-cc-recalc"),realtimeBtn:o.querySelector("#op-cc-realtime"),zoom:1,selectedFree:new Set(N.ccFreeKeys),selectedPaid:new Set(N.ccPaidKeys),realtime:!!N.ccRealtime,overlay:null,lastColorCounts:{},isStale:!1},Z.realtimeBtn.addEventListener("click",(async()=>{Z.realtime=!Z.realtime,Z.realtimeBtn.textContent="Realtime: "+(Z.realtime?"ON":"OFF"),Z.realtimeBtn.classList.toggle("op-danger",Z.realtime),N.ccRealtime=Z.realtime,await Y(["ccRealtime"]),Z.realtime&&Z.isStale&&c()}));const a=async()=>{Z.zoom=Math.min(8,1.25*(Z.zoom||1)),N.ccZoom=Z.zoom,await Y(["ccZoom"]),te(),oe()},n=async()=>{Z.zoom=Math.max(.1,(Z.zoom||1)/1.25),N.ccZoom=Z.zoom,await Y(["ccZoom"]),te(),oe()};function s(){Z.isStale=!0,Z.meta.textContent=Z.meta.textContent.replace(/ \| Status: .+$/,"")+" | Status: pending recalculation"}function c(){ee(),Z.isStale=!1,te(),oe(),ae()}o.querySelector("#op-cc-zoom-in").addEventListener("click",a),o.querySelector("#op-cc-zoom-out").addEventListener("click",n),Z.recalcBtn.addEventListener("click",(()=>{c()})),Z.applyBtn.addEventListener("click",(async()=>{const e=Z.overlay;if(!e)return;if(0===Q().length)return void F("Select at least one color.");if(Z.isStale&&c(),!Z.processedCanvas)return void F("Nothing to apply.");if(Z.processedCanvas.width>=t||Z.processedCanvas.height>=t)return void F("Image too large to apply (must be < 1000√ó1000).");const o=Z.processedCanvas.toDataURL("image/png");e.imageBase64=o,e.imageUrl=null,e.isLocal=!0,await Y(["overlays"]),R(),O(),j();const a=Object.keys(Z.lastColorCounts).length;F(`Overlay updated (${Z.processedCanvas.width}√ó${Z.processedCanvas.height}, ${a} colors).`),V()})),function(){Z.freeGrid.innerHTML="",Z.paidGrid.innerHTML="";for(const[e,t,o]of i){const a=`${e},${t},${o}`,n=document.createElement("div");n.className="op-cc-cell",n.style.background=`rgb(${e},${t},${o})`,n.title=l[a]||a,n.dataset.key=a,n.dataset.type="free",Z.selectedFree.has(a)&&n.classList.add("active"),n.addEventListener("click",(async()=>{Z.selectedFree.has(a)?Z.selectedFree.delete(a):Z.selectedFree.add(a),n.classList.toggle("active",Z.selectedFree.has(a)),N.ccFreeKeys=Array.from(Z.selectedFree),await Y(["ccFreeKeys"]),Z.realtime?ee():Z.isStale=!0,te(),oe(),ne()})),Z.freeGrid.appendChild(n)}for(const[e,t,o]of r){const a=`${e},${t},${o}`,n=document.createElement("div");n.className="op-cc-cell",n.style.background=`rgb(${e},${t},${o})`,n.title=l[a]||a,n.dataset.key=a,n.dataset.type="paid",Z.selectedPaid.has(a)&&n.classList.add("active"),n.addEventListener("click",(async()=>{Z.selectedPaid.has(a)?Z.selectedPaid.delete(a):Z.selectedPaid.add(a),n.classList.toggle("active",Z.selectedPaid.has(a)),N.ccPaidKeys=Array.from(Z.selectedPaid),await Y(["ccPaidKeys"]),Z.realtime?ee():Z.isStale=!0,te(),oe(),ne()})),Z.paidGrid.appendChild(n)}ne()}(),Z.freeToggle.addEventListener("click",(async()=>{le("free",!ie()),N.ccFreeKeys=Array.from(Z.selectedFree),await Y(["ccFreeKeys"]),Z.realtime?c():s(),te(),oe(),ne()})),Z.paidToggle.addEventListener("click",(async()=>{le("paid",!re()),N.ccPaidKeys=Array.from(Z.selectedPaid),await Y(["ccPaidKeys"]),Z.realtime?c():s(),te(),oe(),ne()}))}(),function(){const e=document.createElement("div");e.className="op-rs-backdrop",e.id="op-rs-backdrop",document.body.appendChild(e);const o=document.createElement("div");o.className="op-rs-modal",o.id="op-rs-modal",o.style.display="none",o.innerHTML='\n      <div class="op-rs-header" id="op-rs-header">\n        <div class="op-rs-title">Resize Overlay</div>\n        <button class="op-rs-close" id="op-rs-close" title="Close">‚úï</button>\n      </div>\n\n      <div class="op-rs-tabs">\n        <button class="op-rs-tab-btn active" id="op-rs-tab-simple">Simple</button>\n        <button class="op-rs-tab-btn" id="op-rs-tab-advanced">Advanced (grid)</button>\n      </div>\n\n      <div class="op-rs-body">\n        <div class="op-rs-pane show" id="op-rs-pane-simple">\n          <div class="op-rs-row">\n            <label style="width:110px;">Original</label>\n            <input type="text" class="op-input" id="op-rs-orig" disabled>\n          </div>\n          <div class="op-rs-row">\n            <label style="width:110px;">Width</label>\n            <input type="number" min="1" step="1" class="op-input" id="op-rs-w">\n          </div>\n          <div class="op-rs-row">\n            <label style="width:110px;">Height</label>\n            <input type="number" min="1" step="1" class="op-input" id="op-rs-h">\n          </div>\n          <div class="op-rs-row">\n            <input type="checkbox" id="op-rs-lock" checked>\n            <label for="op-rs-lock">Lock aspect ratio</label>\n          </div>\n          <div class="op-rs-row" style="gap:6px; flex-wrap:wrap;">\n            <label style="width:110px;">Quick</label>\n            <button class="op-button" id="op-rs-double">2x</button>\n            <button class="op-button" id="op-rs-onex">1x</button>\n            <button class="op-button" id="op-rs-half">0.5x</button>\n            <button class="op-button" id="op-rs-third">0.33x</button>\n            <button class="op-button" id="op-rs-quarter">0.25x</button>\n          </div>\n          <div class="op-rs-row">\n            <label style="width:110px;">Scale factor</label>\n            <input type="number" step="0.01" min="0.01" class="op-input" id="op-rs-scale" placeholder="e.g. 0.5">\n            <button class="op-button" id="op-rs-apply-scale">Apply</button>\n          </div>\n\n          <div class="op-rs-preview-wrap" id="op-rs-sim-wrap">\n            <div class="op-rs-dual">\n              <div class="op-rs-col" id="op-rs-col-left">\n                <div class="label">Original</div>\n                <div class="pad-top"></div>\n                <canvas id="op-rs-sim-orig" class="op-rs-canvas op-rs-thumb"></canvas>\n              </div>\n              <div class="op-rs-col" id="op-rs-col-right">\n                <div class="label">Result (downscale ‚Üí upscale preview)</div>\n                <div class="pad-top"></div>\n                <canvas id="op-rs-sim-new" class="op-rs-canvas op-rs-thumb"></canvas>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div class="op-rs-pane" id="op-rs-pane-advanced">\n          <div class="op-rs-preview-wrap op-pan-grab" id="op-rs-adv-wrap">\n            <canvas id="op-rs-preview" class="op-rs-canvas"></canvas>\n            <div class="op-rs-zoom">\n              <button class="op-icon-btn" id="op-rs-zoom-out" title="Zoom out">‚àí</button>\n              <button class="op-icon-btn" id="op-rs-zoom-in" title="Zoom in">+</button>\n            </div>\n          </div>\n\n          <div class="op-rs-row" style="margin-top:8px;">\n            <label style="width:160px;">Multiplier</label>\n            <input type="range" id="op-rs-mult-range" min="1" max="64" step="0.1" style="flex:1;">\n            <input type="number" id="op-rs-mult-input" class="op-input op-rs-mini" min="1" step="0.05">\n          </div>\n\n          <div class="op-rs-row">\n            <input type="checkbox" id="op-rs-bind" checked>\n            <label for="op-rs-bind">Bind X/Y block sizes</label>\n          </div>\n\n          <div class="op-rs-row">\n            <label style="width:160px;">Block W / H</label>\n            <input type="number" id="op-rs-blockw" class="op-input op-rs-mini" min="1" step="0.1">\n            <input type="number" id="op-rs-blockh" class="op-input op-rs-mini" min="1" step="0.1">\n          </div>\n\n          <div class="op-rs-row">\n            <label style="width:160px;">Offset X / Y</label>\n            <input type="number" id="op-rs-offx" class="op-input op-rs-mini" min="0" step="0.1">\n            <input type="number" id="op-rs-offy" class="op-input op-rs-mini" min="0" step="0.1">\n          </div>\n\n          <div class="op-rs-row">\n            <label style="width:160px;">Dot radius</label>\n            <input type="range" id="op-rs-dotr" min="1" max="8" step="1" style="flex:1;">\n            <span id="op-rs-dotr-val" class="op-muted" style="width:36px; text-align:right;"></span>\n          </div>\n\n          <div class="op-rs-row">\n            <input type="checkbox" id="op-rs-grid" checked>\n            <label for="op-rs-grid">Show grid wireframe</label>\n          </div>\n\n          <div class="op-rs-grid-note" id="op-rs-adv-note">Align red dots to block centers. Drag to pan; use buttons or Ctrl+wheel to zoom.</div>\n\n          <div class="op-rs-row" style="margin-top:8px;">\n            <label style="width:160px;">Calculated preview</label>\n            <span class="op-muted" id="op-rs-adv-resmeta"></span>\n          </div>\n          <div class="op-rs-preview-wrap" id="op-rs-adv-result-wrap" style="height: clamp(200px, 26vh, 420px);">\n            <canvas id="op-rs-adv-result" class="op-rs-canvas"></canvas>\n          </div>\n        </div>\n      </div>\n\n      <div class="op-rs-footer">\n        <div class="op-cc-ghost" id="op-rs-meta">Nearest-neighbor OR grid center sampling; alpha hardened (no semi-transparent pixels).</div>\n        <div class="op-cc-actions">\n          <button class="op-button" id="op-rs-calc">Calculate</button>\n          <button class="op-button" id="op-rs-apply">Apply</button>\n          <button class="op-button" id="op-rs-cancel">Cancel</button>\n        </div>\n      </div>\n    ',document.body.appendChild(o);const a={backdrop:e,modal:o,tabSimple:o.querySelector("#op-rs-tab-simple"),tabAdvanced:o.querySelector("#op-rs-tab-advanced"),paneSimple:o.querySelector("#op-rs-pane-simple"),paneAdvanced:o.querySelector("#op-rs-pane-advanced"),orig:o.querySelector("#op-rs-orig"),w:o.querySelector("#op-rs-w"),h:o.querySelector("#op-rs-h"),lock:o.querySelector("#op-rs-lock"),note:o.querySelector("#op-rs-note"),onex:o.querySelector("#op-rs-onex"),half:o.querySelector("#op-rs-half"),third:o.querySelector("#op-rs-third"),quarter:o.querySelector("#op-rs-quarter"),double:o.querySelector("#op-rs-double"),scale:o.querySelector("#op-rs-scale"),applyScale:o.querySelector("#op-rs-apply-scale"),simWrap:o.querySelector("#op-rs-sim-wrap"),simOrig:o.querySelector("#op-rs-sim-orig"),simNew:o.querySelector("#op-rs-sim-new"),colLeft:o.querySelector("#op-rs-col-left"),colRight:o.querySelector("#op-rs-col-right"),advWrap:o.querySelector("#op-rs-adv-wrap"),preview:o.querySelector("#op-rs-preview"),meta:o.querySelector("#op-rs-meta"),zoomIn:o.querySelector("#op-rs-zoom-in"),zoomOut:o.querySelector("#op-rs-zoom-out"),multRange:o.querySelector("#op-rs-mult-range"),multInput:o.querySelector("#op-rs-mult-input"),bind:o.querySelector("#op-rs-bind"),blockW:o.querySelector("#op-rs-blockw"),blockH:o.querySelector("#op-rs-blockh"),offX:o.querySelector("#op-rs-offx"),offY:o.querySelector("#op-rs-offy"),dotR:o.querySelector("#op-rs-dotr"),dotRVal:o.querySelector("#op-rs-dotr-val"),gridToggle:o.querySelector("#op-rs-grid"),advNote:o.querySelector("#op-rs-adv-note"),resWrap:o.querySelector("#op-rs-adv-result-wrap"),resCanvas:o.querySelector("#op-rs-adv-result"),resMeta:o.querySelector("#op-rs-adv-resmeta"),calcBtn:o.querySelector("#op-rs-calc"),applyBtn:o.querySelector("#op-rs-apply"),cancelBtn:o.querySelector("#op-rs-cancel"),closeBtn:o.querySelector("#op-rs-close")},n=a.preview.getContext("2d",{willReadFrequently:!0}),i=a.simOrig.getContext("2d",{willReadFrequently:!0}),r=a.simNew.getContext("2d",{willReadFrequently:!0}),l=a.resCanvas.getContext("2d",{willReadFrequently:!0});se={...a,ov:null,img:null,origW:0,origH:0,mode:"simple",zoom:1,updating:!1,mult:4,gapX:4,gapY:4,offx:0,offy:0,dotr:1,viewX:0,viewY:0,panning:!1,panStart:null,calcCanvas:null,calcCols:0,calcRows:0,calcReady:!1};const s=()=>{const e=parseInt(se.w.value||"0",10),o=parseInt(se.h.value||"0",10);return Number.isFinite(e)&&Number.isFinite(o)&&e>0&&o>0?e>=t||o>=t?`Target: ${e}√ó${o} (exceeds limit: must be < 1000√ó1000)`:`Target: ${e}√ó${o} (OK)`:"Enter positive width and height."},c=()=>{const e=Math.floor((se.origW-se.offx)/se.gapX),t=Math.floor((se.origH-se.offy)/se.gapY);return{cols:Math.max(0,e),rows:Math.max(0,t)}},d=()=>{const{cols:e,rows:o}=c();return e>0&&o>0?`Samples: ${e} √ó ${o} | Output: ${e}√ó${o}${e>=t||o>=t?" (exceeds limit: < 1000√ó1000)":""}`:"Adjust multiplier/offset until dots sit at centers."},p=()=>{se.meta.textContent="advanced"===se.mode?d():s()},u=()=>{const e=parseInt(se.w.value||"0",10),o=parseInt(se.h.value||"0",10),a=Number.isFinite(e)&&Number.isFinite(o)&&e>0&&o>0,n=e>=t||o>=t,i=a?n?`Target: ${e}√ó${o} (exceeds limit: must be < 1000√ó1000)`:`Target: ${e}√ó${o} (OK)`:"Enter positive width and height.";se.note&&(se.note.textContent=i),"simple"===se.mode&&(se.applyBtn.disabled=!a||n),"simple"===se.mode&&(se.meta.textContent=i)};function g(e){const t=Math.max(1,Math.round(se.origW*e)),o=Math.max(1,Math.round(se.origH*e));se.updating=!0,se.w.value=t,se.h.value=se.lock.checked?Math.max(1,Math.round(t*se.origH/se.origW)):o,se.updating=!1,u()}function h(){if(!se.img)return;const e=se.colLeft.querySelector(".pad-top").offsetHeight,t=se.colRight.querySelector(".pad-top").offsetHeight,o=se.colLeft.clientWidth,a=se.colRight.clientWidth,n=se.colLeft.clientHeight-e,l=se.colRight.clientHeight-t;se.simOrig.width=o,se.simOrig.height=n,se.simNew.width=a,se.simNew.height=l,i.save(),i.imageSmoothingEnabled=!1,i.clearRect(0,0,o,n);const s=Math.min(o/se.origW,n/se.origH),c=Math.max(1,Math.floor(se.origW*s)),d=Math.max(1,Math.floor(se.origH*s)),p=Math.floor((o-c)/2),u=Math.floor((n-d)/2);i.drawImage(se.img,0,0,se.origW,se.origH,p,u,c,d),i.restore();const g=parseInt(se.w.value||"0",10),v=parseInt(se.h.value||"0",10);if(r.save(),r.imageSmoothingEnabled=!1,r.clearRect(0,0,a,l),Number.isFinite(g)&&Number.isFinite(v)&&g>0&&v>0){const e=m(g,v),t=e.getContext("2d",{willReadFrequently:!0});t.imageSmoothingEnabled=!1,t.clearRect(0,0,g,v),t.drawImage(se.img,0,0,se.origW,se.origH,0,0,g,v);const o=t.getImageData(0,0,g,v),n=o.data;for(let e=0;e<n.length;e+=4)0!==n[e+3]&&(n[e+3]=255);t.putImageData(o,0,0);const i=Math.min(a/g,l/v),s=Math.max(1,Math.floor(g*i)),c=Math.max(1,Math.floor(v*i)),d=Math.floor((a-s)/2),p=Math.floor((l-c)/2);r.drawImage(e,0,0,g,v,d,p,s,c)}else r.drawImage(se.img,0,0,se.origW,se.origH,p,u,c,d);r.restore()}const b=()=>{se.updating=!0,se.multRange.value=String(se.mult),se.multInput.value=String(se.mult),se.blockW.value=String(se.gapX),se.blockH.value=String(se.gapY),se.offX.value=String(se.offx),se.offY.value=String(se.offy),se.dotR.value=String(se.dotr),se.dotRVal.textContent=String(se.dotr),se.updating=!1};function y(){const{cols:e,rows:o}=c();if("advanced"===se.mode)se.applyBtn.disabled=!se.calcReady;else{const e=parseInt(se.w.value||"0",10),o=parseInt(se.h.value||"0",10),a=Number.isFinite(e)&&Number.isFinite(o)&&e>0&&o>0&&e<t&&o<t;se.applyBtn.disabled=!a}p()}function w(){if("advanced"!==se.mode||!se.img)return;const e=se.origW,t=se.origH,o=Math.max(50,Math.floor(se.advWrap.clientWidth)),a=Math.max(50,Math.floor(se.advWrap.clientHeight));se.preview.width=o,se.preview.height=a;const i=Math.max(1,Math.floor(o/se.zoom)),r=Math.max(1,Math.floor(a/se.zoom)),l=Math.max(0,e-i),s=Math.max(0,t-r);if(se.viewX=Math.min(Math.max(0,se.viewX),l),se.viewY=Math.min(Math.max(0,se.viewY),s),n.save(),n.imageSmoothingEnabled=!1,n.clearRect(0,0,o,a),n.drawImage(se.img,se.viewX,se.viewY,i,r,0,0,o,a),se.gridToggle.checked&&se.gapX>=1&&se.gapY>=1){n.strokeStyle="rgba(255,59,48,0.45)",n.lineWidth=1;const e=Math.ceil((se.viewX-se.offx)/se.gapX),t=Math.floor((se.viewX+i-se.offx)/se.gapX),l=Math.ceil((se.viewY-se.offy)/se.gapY),s=Math.floor((se.viewY+r-se.offy)/se.gapY),c=Math.max(0,t-e+1),d=Math.max(0,s-l+1);if(c<=4e3&&d<=4e3){n.beginPath();for(let o=e;o<=t;o++){const e=se.offx+o*se.gapX,t=Math.round((e-se.viewX)*se.zoom);n.moveTo(t+.5,0),n.lineTo(t+.5,a)}for(let e=l;e<=s;e++){const t=se.offy+e*se.gapY,a=Math.round((t-se.viewY)*se.zoom);n.moveTo(0,a+.5),n.lineTo(o,a+.5)}n.stroke()}}if(se.gapX>=1&&se.gapY>=1){n.fillStyle="#ff3b30";const e=se.offx+Math.floor(se.gapX/2),t=se.offy+Math.floor(se.gapY/2);if(e>=0&&t>=0){const o=Math.ceil((se.viewX-e)/se.gapX),a=Math.ceil((se.viewY-t)/se.gapY),l=Math.floor((se.viewY+r-1-t)/se.gapY),s=Math.floor((se.viewX+i-1-e)/se.gapX),c=se.dotr;if(Math.max(0,s-o+1)*Math.max(0,l-a+1)<=3e5)for(let i=a;i<=l;i++){const a=t+i*se.gapY;for(let t=o;t<=s;t++){const o=e+t*se.gapX,i=Math.round((o-se.viewX)*se.zoom),r=Math.round((a-se.viewY)*se.zoom);n.beginPath(),n.arc(i,r,c,0,2*Math.PI),n.fill()}}}}n.restore()}function k(){const e=se.calcCanvas,o=se.resWrap;if(!o||!e)return l.clearRect(0,0,se.resCanvas.width,se.resCanvas.height),void(se.resMeta.textContent="No result. Click Calculate.");const a=e.width,n=e.height,i=Math.max(50,Math.floor(o.clientWidth-16)),r=Math.max(50,Math.floor(o.clientHeight-16)),s=Math.min(i/a,r/n),c=Math.max(1,Math.floor(a*s)),d=Math.max(1,Math.floor(n*s));se.resCanvas.width=c,se.resCanvas.height=d,l.save(),l.imageSmoothingEnabled=!1,l.clearRect(0,0,c,d),l.drawImage(e,0,0,a,n,0,0,c,d),l.restore(),se.resMeta.textContent=`Output: ${a}√ó${n}${a>=t||n>=t?" (exceeds limit: < 1000√ó1000)":""}`}se._drawSimplePreview=h,se._drawAdvancedPreview=w,se._drawAdvancedResultPreview=k;const C=e=>{se.mode=e,se.tabSimple.classList.toggle("active","simple"===e),se.tabAdvanced.classList.toggle("active","advanced"===e),se.paneSimple.classList.toggle("show","simple"===e),se.paneAdvanced.classList.toggle("show","advanced"===e),p(),se.calcBtn.style.display="advanced"===e?"inline-block":"none","advanced"===e?se.applyBtn.disabled=!se.calcReady:u(),y(),"advanced"===e?(w(),k()):h()};se.tabSimple.addEventListener("click",(()=>C("simple"))),se.tabAdvanced.addEventListener("click",(()=>C("advanced")));const M=()=>{if(se.updating)return;se.updating=!0;const e=parseInt(se.w.value||"0",10);se.lock.checked&&se.origW>0&&se.origH>0&&e>0&&(se.h.value=Math.max(1,Math.round(e*se.origH/se.origW))),se.updating=!1,u(),"simple"===se.mode&&h()},L=()=>{if(se.updating)return;se.updating=!0;const e=parseInt(se.h.value||"0",10);se.lock.checked&&se.origW>0&&se.origH>0&&e>0&&(se.w.value=Math.max(1,Math.round(e*se.origW/se.origH))),se.updating=!1,u(),"simple"===se.mode&&h()};se.w.addEventListener("input",M),se.h.addEventListener("input",L),se.onex.addEventListener("click",(()=>{g(1),h()})),se.half.addEventListener("click",(()=>{g(.5),h()})),se.third.addEventListener("click",(()=>{g(1/3),h()})),se.quarter.addEventListener("click",(()=>{g(1/4),h()})),se.double.addEventListener("click",(()=>{g(2),h()})),se.applyScale.addEventListener("click",(()=>{const e=parseFloat(se.scale.value||"");!Number.isFinite(e)||e<=0?F("Enter a valid scale factor > 0"):(g(e),h())}));const E=()=>{"advanced"===se.mode&&(se.calcReady=!1,se.applyBtn.disabled=!0,k(),p())},S=e=>{if(se.updating)return;const t=parseFloat(e);if(!Number.isFinite(t))return;const o=Math.min(Math.max(t,1),128);se.mult=o,se.bind.checked&&(se.gapX=o,se.gapY=o),b(),y(),w(),E()};se.multRange.addEventListener("input",(e=>{se.updating||S(e.target.value)})),se.multInput.addEventListener("input",(e=>{if(se.updating)return;const t=e.target.value;Number.isFinite(parseFloat(t))&&S(t)})),se.bind.addEventListener("change",(()=>{se.bind.checked&&(se.gapX=se.mult,se.gapY=se.mult,b()),y(),w(),E()})),se.blockW.addEventListener("input",(e=>{if(se.updating)return;const t=e.target.value,o=parseFloat(t);Number.isFinite(o)&&(se.gapX=Math.min(Math.max(o,1),4096),se.bind.checked&&(se.mult=se.gapX,se.gapY=se.gapX),b(),y(),w(),E())})),se.blockH.addEventListener("input",(e=>{if(se.updating)return;const t=e.target.value,o=parseFloat(t);Number.isFinite(o)&&(se.gapY=Math.min(Math.max(o,1),4096),se.bind.checked&&(se.mult=se.gapY,se.gapX=se.gapY),b(),y(),w(),E())})),se.offX.addEventListener("input",(e=>{const t=e.target.value,o=parseFloat(t);Number.isFinite(o)&&(se.offx=Math.min(Math.max(o,0),Math.max(0,se.origH-1e-4)),se.viewX=Math.min(se.viewX,Math.max(0,se.origW-1)),y(),w(),E())})),se.offY.addEventListener("input",(e=>{const t=e.target.value,o=parseFloat(t);Number.isFinite(o)&&(se.offy=Math.min(Math.max(o,0),Math.max(0,se.origH-1e-4)),se.viewY=Math.min(se.viewY,Math.max(0,se.origH-1)),y(),w(),E())})),se.dotR.addEventListener("input",(e=>{se.dotr=Math.max(1,Math.round(Number(e.target.value)||1)),se.dotRVal.textContent=String(se.dotr),w()})),se.gridToggle.addEventListener("change",w);const $=e=>{const t=Math.max(50,Math.floor(se.advWrap.clientWidth)),o=Math.max(50,Math.floor(se.advWrap.clientHeight)),a=Math.max(1,Math.floor(t/se.zoom)),n=Math.max(1,Math.floor(o/se.zoom)),i=se.viewX+a/2,r=se.viewY+n/2;se.zoom=Math.min(32,Math.max(.1,se.zoom*e));const l=Math.max(1,Math.floor(t/se.zoom)),s=Math.max(1,Math.floor(o/se.zoom));se.viewX=Math.min(Math.max(0,Math.round(i-l/2)),Math.max(0,se.origW-l)),se.viewY=Math.min(Math.max(0,Math.round(r-s/2)),Math.max(0,se.origH-s)),w()};se.zoomIn.addEventListener("click",(()=>$(1.25))),se.zoomOut.addEventListener("click",(()=>$(.8))),se.advWrap.addEventListener("wheel",(e=>{if(!e.ctrlKey)return;e.preventDefault();const t=e.deltaY||0;$(t>0?1/1.15:1.15)}),{passive:!1});const I=e=>{e.target.closest(".op-rs-zoom")||(se.panning=!0,se.panStart={x:e.clientX,y:e.clientY,viewX:se.viewX,viewY:se.viewY},se.advWrap.classList.remove("op-pan-grab"),se.advWrap.classList.add("op-pan-grabbing"),se.advWrap.setPointerCapture?.(e.pointerId))},B=e=>{if(!se.panning)return;const t=e.clientX-se.panStart.x,o=e.clientY-se.panStart.y,a=se.advWrap.clientWidth,n=se.advWrap.clientHeight,i=Math.max(1,Math.floor(a/se.zoom)),r=Math.max(1,Math.floor(n/se.zoom));let l=se.panStart.viewX-Math.round(t/se.zoom),s=se.panStart.viewY-Math.round(o/se.zoom);l=Math.min(Math.max(0,l),Math.max(0,se.origW-i)),s=Math.min(Math.max(0,s),Math.max(0,se.origH-r)),se.viewX=l,se.viewY=s,w()},P=e=>{se.panning&&(se.panning=!1,se.panStart=null,se.advWrap.classList.remove("op-pan-grabbing"),se.advWrap.classList.add("op-pan-grab"),se.advWrap.releasePointerCapture?.(e.pointerId))};se.advWrap.addEventListener("pointerdown",I),se.advWrap.addEventListener("pointermove",B),se.advWrap.addEventListener("pointerup",P),se.advWrap.addEventListener("pointercancel",P),se.advWrap.addEventListener("pointerleave",P);const D=()=>ce();se.cancelBtn.addEventListener("click",D),se.closeBtn.addEventListener("click",D),e.addEventListener("click",D),se.calcBtn.addEventListener("click",(async()=>{if("advanced"===se.mode)try{const{cols:e,rows:o}=c();if(e<=0||o<=0)return void F("No samples. Adjust multiplier/offset.");if(e>=t||o>=t)return void F("Output too large. Must be < 1000√ó1000.");const a=await async function(e,t,o,a,n,i,r){const l=m(t,o).getContext("2d",{willReadFrequently:!0});l.imageSmoothingEnabled=!1,l.drawImage(e,0,0);const s=l.getImageData(0,0,t,o).data,c=Math.floor((t-a)/i),d=Math.floor((o-n)/r);if(c<=0||d<=0)throw new Error("No samples available with current offset/gap");const p=v(c,d),u=p.getContext("2d"),g=u.createImageData(c,d),h=g.data,f=a+i/2,b=n+r/2,y=(e,t,o)=>Math.min(Math.max(e,t),o);for(let e=0;e<d;e++)for(let a=0;a<c;a++){const n=Math.round(y(f+a*i,0,t-1)),l=4*(Math.round(y(b+e*r,0,o-1))*t+n),d=s[l],p=s[l+1],u=s[l+2],g=4*(e*c+a);0===s[l+3]?(h[g]=0,h[g+1]=0,h[g+2]=0,h[g+3]=0):(h[g]=d,h[g+1]=p,h[g+2]=u,h[g+3]=255)}return u.putImageData(g,0,0),p}(se.img,se.origW,se.origH,se.offx,se.offy,se.gapX,se.gapY);se.calcCanvas=a,se.calcCols=e,se.calcRows=o,se.calcReady=!0,se.applyBtn.disabled=!1,k(),p(),F(`Calculated ${e}√ó${o}. Review preview, then Apply.`)}catch(e){F("Calculation failed.")}})),se.applyBtn.addEventListener("click",(async()=>{if(se.ov)try{if("simple"===se.mode){const e=parseInt(se.w.value||"0",10),o=parseInt(se.h.value||"0",10);if(!Number.isFinite(e)||!Number.isFinite(o)||e<=0||o<=0)return void F("Invalid dimensions");if(e>=t||o>=t)return void F("Too large. Must be < 1000√ó1000.");await async function(e,t,o){const a=await x(e.imageBase64),n=v(t,o),i=n.getContext("2d",{willReadFrequently:!0});i.imageSmoothingEnabled=!1,i.clearRect(0,0,t,o),i.drawImage(a,0,0,a.width,a.height,0,0,t,o);const r=i.getImageData(0,0,t,o),l=r.data;for(let e=3;e<l.length;e+=4)l[e]>0&&(l[e]=255);i.putImageData(r,0,0);const s=n.toDataURL("image/png");e.imageBase64=s,e.imageUrl=null,e.isLocal=!0,await Y(["overlays"]),R(),O(),j()}(se.ov,e,o),ce(),F(`Resized to ${e}√ó${o}.`)}else{if(!se.calcReady||!se.calcCanvas)return void F("Calculate first.");const e=await f(se.calcCanvas);se.ov.imageBase64=e,se.ov.imageUrl=null,se.ov.isLocal=!0,await Y(["overlays"]),R(),O(),j(),ce(),F(`Applied ${se.calcCols}√ó${se.calcRows}.`)}}catch(e){F("Apply failed.")}})),se._syncAdvancedMeta=y,se._syncSimpleNote=u,se._setMode=e=>{const t=new Event("click");("simple"===e?se.tabSimple:se.tabAdvanced).dispatchEvent(t)}}(),function(){const e=e=>document.getElementById(e);e("op-theme-toggle").addEventListener("click",(async e=>{e.stopPropagation(),N.theme="light"===N.theme?"dark":"light",await Y(["theme"]),H()})),e("op-refresh-btn").addEventListener("click",(e=>{e.stopPropagation(),location.reload()})),e("op-mode-select").addEventListener("change",(e=>{N.overlayMode=e.target.value,Y(["overlayMode"]),O(),j()})),e("op-autocap-toggle").addEventListener("click",(()=>{N.autoCapturePixelUrl=!N.autoCapturePixelUrl,Y(["autoCapturePixelUrl"]),O(),j()})),e("op-highlight-toggle").addEventListener("change",(async e=>{N.highlightPixels=e.target.checked,await Y(["highlightPixels"]),R()})),e("op-add-overlay").addEventListener("click",(async()=>{try{await async function(){const e=g("Overlay"),t={id:u(),name:e,enabled:!0,imageUrl:null,imageBase64:null,isLocal:!1,pixelUrl:null,offsetX:0,offsetY:0,opacity:.7,visibleColorKeys:[]};return N.overlays.push(t),N.activeOverlayId=t.id,await Y(["overlays","activeOverlayId"]),R(),O(),j(),t}()}catch(e){}})),e("op-import-overlay").addEventListener("click",(async()=>{const e=prompt("Paste overlay JSON (single or array):");e&&await async function(e){let t;try{t=JSON.parse(e)}catch{return void alert("Invalid JSON")}const o=Array.isArray(t)?t:[t];let a=0,i=0;for(const e of o){const t=g(e.name||"Imported Overlay"),o=e.imageUrl,r=e.pixelUrl??null,l=Number.isFinite(e.offsetX)?e.offsetX:0,s=Number.isFinite(e.offsetY)?e.offsetY:0,c=Number.isFinite(e.opacity)?e.opacity:.7;if(o)try{const e=await n(o),i={id:u(),name:t,enabled:!0,imageUrl:o,imageBase64:e,isLocal:!1,pixelUrl:r,offsetX:l,offsetY:s,opacity:c,visibleColorKeys:[]};N.overlays.push(i),a++}catch(e){i++}else i++}a>0&&(N.activeOverlayId=N.overlays[N.overlays.length-1].id,await Y(["overlays","activeOverlayId"]),R(),O(),j());alert(`Import finished. Imported: ${a}${i?`, Failed: ${i}`:""}`)}(e)})),e("op-export-overlay").addEventListener("click",(()=>function(){const e=X();if(!e)return void alert("No active overlay selected.");if(e.isLocal||!e.imageUrl)return void alert("This overlay uses a local image and cannot be exported. Please host the image and set an image URL.");const t={version:1,name:e.name,imageUrl:e.imageUrl,pixelUrl:e.pixelUrl??null,offsetX:e.offsetX,offsetY:e.offsetY,opacity:e.opacity},o=JSON.stringify(t,null,2);T(o).then((()=>alert("Overlay JSON copied to clipboard!"))).catch((()=>{prompt("Copy the JSON below:",o)}))}())),e("op-collapse-list").addEventListener("click",(()=>{N.collapseList=!N.collapseList,Y(["collapseList"]),j()})),e("op-collapse-editor").addEventListener("click",(()=>{N.collapseEditor=!N.collapseEditor,Y(["collapseEditor"]),j()})),e("op-collapse-nudge").addEventListener("click",(()=>{N.collapseNudge=!N.collapseNudge,Y(["collapseNudge"]),j()})),e("op-collapse-colors").addEventListener("click",(()=>{N.collapseColors=!N.collapseColors,Y(["collapseColors"]),j()})),e("op-colors-refresh").addEventListener("click",(async()=>{$.clear(),await _()})),e("op-colors-all").addEventListener("click",(async()=>{const e=X();e&&(e.visibleColorKeys=null,await Y(["overlays"]),R(),await _())})),e("op-colors-none").addEventListener("click",(async()=>{const e=X();e&&(e.visibleColorKeys=[],await Y(["overlays"]),R(),await _())})),e("op-colors-free").addEventListener("click",(async()=>{const e=X();if(!e)return;const t=await G(e),o=Object.keys(t),a=new Set(i.map((([e,t,o])=>`${e},${t},${o}`)));e.visibleColorKeys=o.filter((e=>a.has(e))),await Y(["overlays"]),R(),await _()})),e("op-colors-paid").addEventListener("click",(async()=>{const e=X();if(!e)return;const t=await G(e),o=Object.keys(t),a=new Set(r.map((([e,t,o])=>`${e},${t},${o}`)));e.visibleColorKeys=o.filter((e=>a.has(e))),await Y(["overlays"]),R(),await _()})),e("op-colors-copy").addEventListener("click",(async()=>{const e=X();if(!e)return;const t=await G(e),o=new Set(r.map((([e,t,o])=>`${e},${t},${o}`))),a=Object.entries(t).sort((([,e],[,t])=>t-e));let n;n=null===e.visibleColorKeys||void 0===e.visibleColorKeys?new Set(Object.keys(t)):new Set(e.visibleColorKeys);const i=a.map((([e,t])=>{const a=o.has(e);return{key:e,name:l[e]||e,premiumStatus:a?"PAID":"FREE",count:t.toString()}}));if(0===i.length)return void T("```\n```").then((()=>F("No color data to copy."))).catch((()=>F("Failed to copy.")));const s=Math.max(...i.map((e=>e.name.length))),c=Math.max(...i.map((e=>e.premiumStatus.length))),d=Math.max(...i.map((e=>e.count.length)));T("```\n"+i.map((({key:e,name:t,premiumStatus:o,count:a})=>`- [${n.has(e)?"x":" "}] ${t.padEnd(s," ")};${o.padEnd(c," ")};${a.padEnd(d," ")};`)).join("\n")+"\n```").then((()=>F("Color data copied to clipboard!"))).catch((()=>F("Failed to copy color data.")))})),e("op-name").addEventListener("change",(async e=>{const t=X();if(!t)return;const o=(e.target.value||"").trim()||"Overlay";N.overlays.some((e=>e.id!==t.id&&(e.name||"").toLowerCase()===o.toLowerCase()))?(t.name=g(o),F(`Name in use. Renamed to "${t.name}".`)):t.name=o,await Y(["overlays"]),A()})),e("op-fetch").addEventListener("click",(async()=>{const t=X();if(!t)return void alert("No active overlay selected.");if(t.imageBase64)return void alert("This overlay already has an image. Create a new overlay to change the image.");const o=e("op-image-url").value.trim();if(o)try{await async function(e,t){const o=await n(t);e.imageUrl=t,e.imageBase64=o,e.isLocal=!1,await Y(["overlays"]),R(),N.autoCapturePixelUrl=!0,await Y(["autoCapturePixelUrl"]),O(),j(),F("Image loaded. Placement mode ON -- click once to set anchor.")}(t,o)}catch(e){alert("Failed to fetch image.")}else alert("Enter an image link first.")}));const o=e("op-dropzone");o.addEventListener("click",(()=>e("op-file-input").click())),e("op-file-input").addEventListener("change",(async e=>{const t=e.target.files&&e.target.files[0];if(e.target.value="",!t)return;const o=X();if(o)if(o.imageBase64)alert("This overlay already has an image. Create a new overlay to change the image.");else try{await W(o,t)}catch(e){alert("Failed to load local image.")}})),["dragenter","dragover"].forEach((e=>o.addEventListener(e,(e=>{e.preventDefault(),e.stopPropagation(),o.classList.add("drop-highlight")})))),["dragleave","drop"].forEach((e=>o.addEventListener(e,(t=>{t.preventDefault(),t.stopPropagation(),"dragleave"===e&&t.target!==o||o.classList.remove("drop-highlight")})))),o.addEventListener("drop",(async e=>{const t=e.dataTransfer;if(!t)return;const o=t.files&&t.files[0];if(!o)return;const a=X();if(a)if(a.imageBase64)alert("This overlay already has an image. Create a new overlay to change the image.");else try{await W(a,o)}catch(e){alert("Failed to load dropped image.")}}));const a=async(e,t)=>{const o=X();o&&(o.offsetX+=e,o.offsetY+=t,await Y(["overlays"]),R(),j())};e("op-nudge-up").addEventListener("click",(()=>a(0,-1))),e("op-nudge-down").addEventListener("click",(()=>a(0,1))),e("op-nudge-left").addEventListener("click",(()=>a(-1,0))),e("op-nudge-right").addEventListener("click",(()=>a(1,0))),e("op-opacity-slider").addEventListener("input",(e=>{const t=X();t&&(t.opacity=parseFloat(e.target.value),document.getElementById("op-opacity-value").textContent=Math.round(100*t.opacity)+"%")})),e("op-opacity-slider").addEventListener("change",(async()=>{await Y(["overlays"]),R()})),e("op-download-overlay").addEventListener("click",(()=>{const e=X();if(!e||!e.imageBase64)return void F("No overlay image to download.");const t=document.createElement("a");t.href=e.imageBase64,t.download=`${(e.name||"overlay").replace(/[^\w.-]+/g,"_")}.png`,document.body.appendChild(t),t.click(),t.remove()})),e("op-open-cc").addEventListener("click",(()=>{const e=X();e&&e.imageBase64?function(e){if(!Z)return;Z.overlay=e,document.body.classList.add("op-scroll-lock"),Z.zoom=Number(N.ccZoom)||1,Z.realtime=!!N.ccRealtime,Z.realtimeBtn.textContent="Realtime: "+(Z.realtime?"ON":"OFF"),Z.realtimeBtn.classList.toggle("op-danger",Z.realtime);const t=new Image;t.onload=()=>{Z.sourceCanvas||(Z.sourceCanvas=document.createElement("canvas"),Z.sourceCtx=Z.sourceCanvas.getContext("2d",{willReadFrequently:!0})),Z.sourceCanvas.width=t.width,Z.sourceCanvas.height=t.height,Z.sourceCtx.clearRect(0,0,t.width,t.height),Z.sourceCtx.drawImage(t,0,0),Z.sourceImageData=Z.sourceCtx.getImageData(0,0,t.width,t.height),Z.processedCanvas||(Z.processedCanvas=document.createElement("canvas"),Z.processedCtx=Z.processedCanvas.getContext("2d")),ee(),Z.isStale=!1,te(),oe(),ae(),Z.backdrop.classList.add("show"),Z.modal.style.display="flex"},t.src=e.imageBase64}(e):F("No overlay image to edit.")}));const s=e("op-open-resize");s&&s.addEventListener("click",(()=>{const e=X();e&&e.imageBase64?function(e){if(!se)return;se.ov=e;const o=new Image;o.onload=()=>{se.img=o,se.origW=o.width,se.origH=o.height,se.orig.value=`${se.origW}√ó${se.origH}`,se.w.value=String(se.origW),se.h.value=String(se.origH),se.lock.checked=!0,se.zoom=1,se.mult=4,se.gapX=4,se.gapY=4,se.offx=0,se.offy=0,se.dotr=1,se.viewX=0,se.viewY=0,se.bind.checked=!0,se.multRange.value="4",se.multInput.value="4",se.blockW.value="4",se.blockH.value="4",se.offX.value="0",se.offY.value="0",se.dotR.value="1",se.dotRVal.textContent="1",se.gridToggle.checked=!0,se.calcCanvas=null,se.calcCols=0,se.calcRows=0,se.calcReady=!1,se.applyBtn.disabled="advanced"===se.mode,se._setMode("simple"),document.body.classList.add("op-scroll-lock"),se.backdrop.classList.add("show"),se.modal.style.display="flex",se._drawSimplePreview?.(),se._drawAdvancedPreview?.(),se._drawAdvancedResultPreview?.(),se._syncAdvancedMeta?.(),se._syncSimpleNote?.();(()=>{if("advanced"===se.mode){const{cols:e,rows:o}=function(){const e=Math.floor((se.origW-se.offx)/se.gapX),t=Math.floor((se.origH-se.offy)/se.gapY);return{cols:Math.max(0,e),rows:Math.max(0,t)}}();se.meta.textContent=e>0&&o>0?`Samples: ${e} √ó ${o} | Output: ${e}√ó${o}${e>=t||o>=t?" (exceeds limit: < 1000√ó1000)":""}`:"Adjust multiplier/offset until dots sit at centers."}else{const e=parseInt(se.w.value||"0",10),o=parseInt(se.h.value||"0",10),a=Number.isFinite(e)&&Number.isFinite(o)&&e>0&&o>0,n=e>=t||o>=t;se.meta.textContent=a?n?`Target: ${e}√ó${o} (exceeds limit: must be < 1000√ó1000)`:`Target: ${e}√ó${o} (OK)`:"Enter positive width and height."}})();const e=()=>{"simple"===se.mode?se._drawSimplePreview?.():(se._drawAdvancedPreview?.(),se._drawAdvancedResultPreview?.())};se._resizeHandler=e,window.addEventListener("resize",e)},o.src=e.imageBase64}(e):F("No overlay image to resize.")}));window.addEventListener("resize",(()=>{}))}(),function(e){const t=e.querySelector("#op-header"),o=e.querySelector("#op-panel-toggle");if(!t||!o)return;let a=!1,n=0,i=0,r=0,l=0,s=!1;const c=(e,t,o)=>Math.min(Math.max(e,t),o),d=c=>{const d=e.classList.contains("collapsed"),p=d?o:t;if(d){if(c.target!==o)return}else if(!c.target.closest("#op-header")||c.target.closest("button"))return;a=!0,s=!1,n=c.clientX,i=c.clientY;const u=e.getBoundingClientRect();r=u.left,l=u.top,p.setPointerCapture?.(c.pointerId),c.preventDefault()},p=t=>{if(!a)return;const o=t.clientX-n,d=t.clientY-i,p=Math.max(8,window.innerWidth-e.offsetWidth-8),u=Math.max(8,window.innerHeight-e.offsetHeight-8);e.style.left=c(r+o,8,p)+"px",e.style.top=c(l+d,8,u)+"px",s=!0},u=n=>{if(!a)return;const i=e.classList.contains("collapsed");a=!1,(i?o:t).releasePointerCapture?.(n.pointerId),s&&(N.panelX=parseInt(e.style.left,10)||0,N.panelY=parseInt(e.style.top,10)||0,Y(["panelX","panelY"]))};e.addEventListener("pointerdown",d),e.addEventListener("pointermove",p),e.addEventListener("pointerup",u),e.addEventListener("pointercancel",u),window.addEventListener("resize",(()=>{const t=e.getBoundingClientRect(),o=Math.max(8,window.innerWidth-e.offsetWidth-8),a=Math.max(8,window.innerHeight-e.offsetHeight-8),n=Math.min(Math.max(t.left,8),o),i=Math.min(Math.max(t.top,8),a);e.style.left=n+"px",e.style.top=i+"px",N.panelX=n,N.panelY=i,Y(["panelX","panelY"])})),o.addEventListener("click",(e=>{if(s)return e.preventDefault(),void e.stopPropagation();N.isPanelCollapsed=!N.isPanelCollapsed,Y(["isPanelCollapsed"]),j()}))}(e),j()}function X(){return N.overlays.find((e=>e.id===N.activeOverlayId))||null}function A(){const e=document.getElementById("op-overlay-list");if(e){e.innerHTML="";for(const t of N.overlays){const o=document.createElement("div");o.className="op-item"+(t.id===N.activeOverlayId?" active":"");const a=t.isLocal?" (local)":t.imageBase64?"":" (no image)";o.innerHTML=`\n        <input type="radio" name="op-active" ${t.id===N.activeOverlayId?"checked":""} title="Set active"/>\n        <input type="checkbox" ${t.enabled?"checked":""} title="Toggle enabled"/>\n        <div class="op-item-name" title="${(t.name||"(unnamed)")+a}">${(t.name||"(unnamed)")+a}</div>\n        <button class="op-icon-btn" title="Delete overlay">üóëÔ∏è</button>\n      `;const[n,i,r,l]=o.children;n.addEventListener("change",(()=>{N.activeOverlayId=t.id,Y(["activeOverlayId"]),j()})),i.addEventListener("change",(()=>{t.enabled=i.checked,Y(["overlays"]),R(),O()})),r.addEventListener("click",(()=>{N.activeOverlayId=t.id,Y(["activeOverlayId"]),j()})),l.addEventListener("click",(async e=>{if(e.stopPropagation(),!confirm(`Delete overlay "${t.name||"(unnamed)"}"?`))return;const o=N.overlays.findIndex((e=>e.id===t.id));o>=0&&(N.overlays.splice(o,1),N.activeOverlayId===t.id&&(N.activeOverlayId=N.overlays[0]?.id||null),await Y(["overlays","activeOverlayId"]),R(),O(),j())})),e.appendChild(o)}}}async function W(e,t){if(!t||!t.type||!t.type.startsWith("image/"))return void alert("Please choose an image file.");if(!confirm("Local PNGs cannot be exported to friends! Are you sure?"))return;const o=await function(e){return new Promise(((t,o)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=o,a.readAsDataURL(e)}))}(t);e.imageBase64=o,e.imageUrl=null,e.isLocal=!0,await Y(["overlays"]),R(),N.autoCapturePixelUrl=!0,await Y(["autoCapturePixelUrl"]),O(),j(),F("Local image loaded. Placement mode ON -- click once to set anchor.")}function T(e){return navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(e):Promise.reject(new Error("Clipboard API not available"))}function H(){document.body.classList.toggle("op-theme-dark","dark"===N.theme),document.body.classList.toggle("op-theme-light","dark"!==N.theme);const e=document.getElementById("op-toast-stack");e&&e.classList.toggle("op-dark","dark"===N.theme)}async function j(){const e=e=>document.getElementById(e),t=e("overlay-pro-panel");if(!t)return;H();const o=e("op-content"),a=e("op-panel-toggle"),n=(e("op-header"),!!N.isPanelCollapsed);t.classList.toggle("collapsed",n),o.style.display=n?"none":"grid",a.classList.toggle("logo-button",n),a.title=n?"Expand":"Collapse";const i=e("op-mode-select");i&&(i.value=N.overlayMode);const r=e("op-autocap-toggle"),l=e("op-place-label");r.textContent=N.autoCapturePixelUrl?"ON":"OFF",r.classList.toggle("op-danger",!!N.autoCapturePixelUrl),l.classList.toggle("op-danger-text",!!N.autoCapturePixelUrl);const s=e("op-highlight-toggle");s&&(s.checked=!!N.highlightPixels);const c=e("op-list-wrap"),d=e("op-collapse-list");c.style.display=N.collapseList?"none":"block",d&&(d.textContent=N.collapseList?"‚ñ∏":"‚ñæ");const p=e("op-nudge-body"),u=e("op-collapse-nudge");p.style.display=N.collapseNudge?"none":"block",u&&(u.textContent=N.collapseNudge?"‚ñ∏":"‚ñæ");const g=e("op-colors-body"),m=e("op-collapse-colors");g&&(g.style.display=N.collapseColors?"none":"block"),m&&(m.textContent=N.collapseColors?"‚ñ∏":"‚ñæ"),A(),function(){const e=e=>document.getElementById(e),t=X(),o=e("op-editor-section"),a=e("op-editor-body");if(o.style.display=t?"flex":"none",!t)return;e("op-name").value=t.name||"";const n=e("op-image-source"),i=e("op-preview-wrap"),r=e("op-image-preview"),l=e("op-cc-btn-row");t.imageBase64?(n.style.display="none",i.style.display="flex",r.src=t.imageBase64,l.style.display="flex"):(n.style.display="block",i.style.display="none",l.style.display="none",e("op-image-url").value=t.imageUrl||"");const s=t.pixelUrl?w(t.pixelUrl):{chunk1:"-",chunk2:"-",posX:"-",posY:"-"};e("op-coord-display").textContent=t.pixelUrl?`Ref: chunk ${s.chunk1}/${s.chunk2} at (${s.posX}, ${s.posY})`:'No pixel anchor set. Turn ON "Place overlay" and click a pixel once.',e("op-opacity-slider").value=String(t.opacity),e("op-opacity-value").textContent=Math.round(100*t.opacity)+"%";const c=document.getElementById("op-offset-indicator");c&&(c.textContent=`Offset X ${t.offsetX}, Y ${t.offsetY}`),a.style.display=N.collapseEditor?"none":"block";const d=document.getElementById("op-collapse-editor");d&&(d.textContent=N.collapseEditor?"‚ñ∏":"‚ñæ")}(),await _();const v=e("op-export-overlay"),h=X(),f=!(!h||!h.imageUrl||h.isLocal);v.disabled=!f,v.title=f?"Export active overlay JSON":"Export disabled for local images"}const K=new Map;async function G(e){if(!e||!e.imageBase64)return{};const t=e.imageBase64.slice(0,64)+":"+e.imageBase64.length;if(K.has(t))return K.get(t);const o=await x(e.imageBase64),a=m(o.width,o.height).getContext("2d",{willReadFrequently:!0});a.drawImage(o,0,0);const n=a.getImageData(0,0,o.width,o.height).data,i={};for(let e=0;e<n.length;e+=4)if(n[e+3]>0){const t=`${n[e]},${n[e+1]},${n[e+2]}`;i[t]=(i[t]||0)+1}return K.set(t,i),i}async function _(){const t=X(),o=document.getElementById("op-colors-section");if(!o)return;if(!t||!t.imageBase64)return void(o.style.display="none");o.style.display="flex";const a=document.getElementById("op-colors-list");a.innerHTML='<div class="op-muted" style="text-align:center; padding: 12px 0;">Loading...</div>';const n=await G(t),i=await async function(t){if(!t||!t.imageBase64||!t.pixelUrl)return null;const o=I(t),a=Array.from(S.keys()).sort().join(";"),n=`${t.id}|${o}|${a}`;if($.has(n))return $.get(n);const i=await x(t.imageBase64),r=i.width,l=i.height,s=m(r,l).getContext("2d",{willReadFrequently:!0});s.drawImage(i,0,0);const c=s.getImageData(0,0,r,l).data,d=w(t.pixelUrl);if(!Number.isFinite(d.chunk1)||!Number.isFinite(d.chunk2))return null;const p={};for(let o=0;o<l;o++)for(let a=0;a<r;a++){const n=4*(o*r+a);if(0===c[n+3])continue;const i=c[n],l=c[n+1],s=c[n+2],u=`${i},${l},${s}`;p[u]||(p[u]={smart:0,below:0});const g=d.chunk1*e+d.posX+t.offsetX+a,m=d.chunk2*e+d.posY+t.offsetY+o,v=`${Math.floor(g/e)},${Math.floor(m/e)}`;if(S.has(v)){const t=S.get(v),o=t.data,a=t.width,n=4*((m%e+e)%e*a+(g%e+e)%e),r=o[n],c=o[n+1],d=o[n+2];0===o[n+3]?p[u].below++:i===r&&l===c&&s===d||p[u].smart++}}return $.set(n,p),p}(t)||{};let s;s=null===t.visibleColorKeys||void 0===t.visibleColorKeys?new Set(Object.keys(n)):new Set(t.visibleColorKeys);const c=Object.entries(n).sort((([,e],[,t])=>t-e)),d=new Set(r.map((([e,t,o])=>`${e},${t},${o}`)));if(a.innerHTML="",0!==c.length){for(const[e,t]of c){const o=d.has(e),n=l[e]||e,r=document.createElement("div");r.className="op-dist-item"+(o?" premium":""),r.title=`${n} (${e}): ${t} pixels`;const c=`<span style="color: cyan;">${i[e]?.below||0}</span>/<span style="color: red;">${i[e]?.smart||0}</span>/${t}`;r.innerHTML=`\n            <input type="checkbox" data-key="${e}" ${s.has(e)?"checked":""} style="margin-right: 4px;">\n            <div class="op-color-list-swatch" style="background-color: rgb(${e});"></div>\n            <div class="op-color-list-name">${n}</div>\n            <div class="op-color-list-count">${c}</div>\n        `,a.appendChild(r)}a.querySelectorAll('input[type="checkbox"]').forEach((e=>{e.addEventListener("change",(async()=>{const t=e.dataset.key,o=X();if(!o)return;if(null===o.visibleColorKeys){const e=Object.keys(await G(o));o.visibleColorKeys=e}const a=new Set(o.visibleColorKeys);e.checked?a.add(t):a.delete(t),o.visibleColorKeys=Array.from(a),await Y(["overlays"]),R()}))}))}else a.innerHTML='<div class="op-muted" style="text-align:center; padding: 12px 0;">No colors found.</div>'}let Z=null;function V(){Z&&(Z.backdrop.classList.remove("show"),Z.modal.style.display="none",Z.overlay=null,document.body.classList.remove("op-scroll-lock"))}function J(e,t,o,a){let n=null,i=1/0;for(let r=0;r<a.length;r++){const[l,s,c]=a[r],d=(l+e)/2,p=l-e,u=s-t,g=c-o,m=((512+d)*p*p>>8)+4*u*u+((767-d)*g*g>>8);m<i&&(i=m,n=[l,s,c])}return n||[0,0,0]}function Q(){const e=[];return Z.selectedFree.forEach((t=>{const[o,a,n]=t.split(",").map((e=>parseInt(e,10)));Number.isFinite(o)&&e.push([o,a,n])})),Z.selectedPaid.forEach((t=>{const[o,a,n]=t.split(",").map((e=>parseInt(e,10)));Number.isFinite(o)&&e.push([o,a,n])})),e}function ee(){if(!Z.sourceImageData)return;const e=Z.sourceImageData.width,t=Z.sourceImageData.height,o=Z.sourceImageData.data,a=new Uint8ClampedArray(o.length),n=Q(),i={};for(let e=0;e<o.length;e+=4){const t=o[e],r=o[e+1],l=o[e+2];if(0===o[e+3]){a[e]=0,a[e+1]=0,a[e+2]=0,a[e+3]=0;continue}const[s,c,d]=n.length?J(t,r,l,n):[t,r,l];a[e]=s,a[e+1]=c,a[e+2]=d,a[e+3]=255;const p=`${s},${c},${d}`;i[p]=(i[p]||0)+1}Z.processedCanvas||(Z.processedCanvas=document.createElement("canvas"),Z.processedCtx=Z.processedCanvas.getContext("2d")),Z.processedCanvas.width=e,Z.processedCanvas.height=t;const r=new ImageData(a,e,t);Z.processedCtx.putImageData(r,0,0),Z.lastColorCounts=i}function te(){const e=Number(Z.zoom)||1,t=Z.processedCanvas;if(!t)return;const o=Math.max(1,Math.round(t.width*e)),a=Math.max(1,Math.round(t.height*e));Z.previewCanvas.width=o,Z.previewCanvas.height=a;const n=Z.previewCtx;n.clearRect(0,0,o,a),n.imageSmoothingEnabled=!1,n.drawImage(t,0,0,t.width,t.height,0,0,o,a),n.imageSmoothingEnabled=!0}function oe(){if(!Z.sourceImageData)return void(Z.meta.textContent="");const e=Z.sourceImageData.width,t=Z.sourceImageData.height,o=Object.keys(Z.lastColorCounts||{}).length,a=Z.isStale?"pending recalculation":"up to date";Z.meta.textContent=`Size: ${e}√ó${t} | Zoom: ${Z.zoom.toFixed(2)}√ó | Colors: ${o} | Status: ${a}`}function ae(){if(!Z||!Z.lastColorCounts)return;const e=document.getElementById("op-cc-color-list");if(!e)return;const t=Z.lastColorCounts,o=Object.entries(t).sort((([,e],[,t])=>t-e)),a=new Set(r.map((([e,t,o])=>`${e},${t},${o}`)));if(e.innerHTML="",0!==o.length)for(const[t,n]of o){const o=a.has(t),i=l[t]||t,r=document.createElement("div");r.className="op-color-list-item"+(o?" premium":""),r.title=`${i} (${t}): ${n} pixels`,r.innerHTML=`\n        <div class="op-color-list-swatch" style="background-color: rgb(${t});"></div>\n        <div class="op-color-list-name">${i}</div>\n        <div class="op-color-list-count">${n}</div>\n      `,e.appendChild(r)}else e.innerHTML='<div class="op-muted" style="text-align:center; padding: 12px 0;">No colors in image.</div>'}function ne(){Z.freeToggle.textContent=ie()?"Unselect All":"Select All",Z.paidToggle.textContent=re()?"Unselect All":"Select All"}function ie(){return s.every((e=>Z.selectedFree.has(e)))}function re(){const e=r.map((([e,t,o])=>`${e},${t},${o}`));return e.every((e=>Z.selectedPaid.has(e)))&&e.length>0}function le(e,t){if("free"===e){const e=s;t?e.forEach((e=>Z.selectedFree.add(e))):Z.selectedFree.clear(),Z.freeGrid.querySelectorAll(".op-cc-cell").forEach((e=>e.classList.toggle("active",t)))}else{const e=r.map((([e,t,o])=>`${e},${t},${o}`));t?e.forEach((e=>Z.selectedPaid.add(e))):Z.selectedPaid.clear(),Z.paidGrid.querySelectorAll(".op-cc-cell").forEach((e=>e.classList.toggle("active",t)))}}let se=null;function ce(){se&&(window.removeEventListener("resize",se._resizeHandler||(()=>{})),se.backdrop.classList.remove("show"),se.modal.style.display="none",se.ov=null,se.img=null,document.body.classList.remove("op-scroll-lock"))}q().then((()=>{O();const e=()=>{!function(){const e=document.createElement("style");e.textContent="\n      body.op-theme-light {\n        --op-bg: #f7f9fc;\n        --op-border: #e1e8f2;\n        --op-muted: #6b7280;\n        --op-text: #1f2937;\n        --op-subtle: #ffffff;\n        --op-btn: #ffffff;\n        --op-btn-border: #d1d9e6;\n        --op-btn-hover: #f0f3f8;\n        --op-accent: #2563eb;\n      }\n      body.op-theme-dark {\n        --op-bg: #111827;\n        --op-border: #374151;\n        --op-muted: #9ca3af;\n        --op-text: #f3f4f6;\n        --op-subtle: #1f2937;\n        --op-btn: #374151;\n        --op-btn-border: #4b5563;\n        --op-btn-hover: #4b5563;\n        --op-accent: #3b82f6;\n      }\n      .op-scroll-lock { overflow: hidden !important; }\n\n      #overlay-pro-panel {\n        position: fixed; z-index: 9999; background: var(--op-bg); border: 1px solid var(--op-border);\n        border-radius: 12px; color: var(--op-text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, \"Apple Color Emoji\", \"Segoe UI Emoji\";\n        font-size: 14px; width: auto; box-shadow: 0 8px 16px rgba(0,0,0,0.1); user-select: none;\n      }\n      #overlay-pro-panel.collapsed {\n        width: auto;\n        background: transparent;\n        border: none;\n        box-shadow: none;\n      }\n\n      .op-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid var(--op-border); border-radius: 12px 12px 0 0; cursor: grab; }\n      .op-header:active { cursor: grabbing; }\n      .op-header h3 { margin: 0; font-size: 15px; font-weight: 600; }\n      .op-header-actions { display: flex; gap: 6px; }\n      #overlay-pro-panel.collapsed .op-header h3,\n      #overlay-pro-panel.collapsed .op-header #op-theme-toggle,\n      #overlay-pro-panel.collapsed .op-header #op-refresh-btn {\n        display: none;\n      }\n      #overlay-pro-panel.collapsed .op-header {\n        border-bottom: none;\n        padding: 0;\n        cursor: default;\n      }\n      #overlay-pro-panel.collapsed .op-header .op-header-actions {\n        justify-content: flex-end;\n        width: 100%;\n      }\n      .op-toggle-btn, .op-hdr-btn { background: var(--op-btn); border: 1px solid var(--op-btn-border); color: var(--op-text); border-radius: 8px; padding: 4px 8px; cursor: pointer; }\n      .op-toggle-btn:hover, .op-hdr-btn:hover { background: var(--op-btn); }\n      #op-panel-toggle.logo-button {\n          background-image: url(\"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232563eb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M12 2.69l5.66 5.66a8 8 0 1 1-11.32 0L12 2.69z'/%3e%3c/svg%3e\");\n          background-color: var(--op-bg);\n          background-size: 24px 24px;\n          background-repeat: no-repeat;\n          background-position: center;\n          width: 42px;\n          height: 42px;\n          border: 1px solid var(--op-border);\n          border-radius: 50%;\n          text-indent: -9999px;\n          box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n          transition: all 0.2s ease-in-out;\n          cursor: grab;\n      }\n      #op-panel-toggle.logo-button:hover {\n          transform: scale(1.1);\n          box-shadow: 0 6px 16px rgba(0,0,0,0.15);\n      }\n\n      .op-content { padding: 12px; display: grid; grid-template-columns: 1fr 320px; gap: 12px; }\n      .op-section { display: flex; flex-direction: column; gap: 8px; background: var(--op-subtle); border: 1px solid var(--op-border); border-radius: 10px; padding: 8px; }\n\n      .op-section-title { display: flex; align-items: center; justify-content: space-between; }\n      .op-title-text { font-weight: 600; }\n      .op-chevron { background: var(--op-btn); border: 1px solid var(--op-btn-border); border-radius: 6px; padding: 2px 6px; cursor: pointer; }\n      .op-chevron:hover { background: var(--op-btn); }\n\n      .op-row { display: flex; align-items: center; gap: 8px; }\n      .op-row.space { justify-content: space-between; }\n\n      .op-button { background: var(--op-btn); color: var(--op-text); border: 1px solid var(--op-btn-border); border-radius: 8px; padding: 6px 10px; cursor: pointer; }\n      .op-button:hover { background: var(--op-btn-hover); }\n      .op-button:disabled { opacity: 0.5; cursor: not-allowed; }\n      .op-button.icon { width: 30px; height: 30px; padding: 0; display: inline-flex; align-items: center; justify-content: center; font-size: 16px; }\n\n      .op-input, .op-select { background: var(--op-bg); border: 1px solid var(--op-border); color: var(--op-text); border-radius: 8px; padding: 6px 8px; }\n      .op-slider { width: 100%; }\n\n      .op-list { display: flex; flex-direction: column; gap: 6px; max-height: 140px; overflow: auto; border: 1px solid var(--op-border); padding: 6px; border-radius: 8px; background: var(--op-bg); }\n\n      .op-item { display: flex; align-items: center; gap: 6px; padding: 6px; border-radius: 8px; border: 1px solid var(--op-border); background: var(--op-subtle); }\n      .op-item.active { outline: 2px solid color-mix(in oklab, var(--op-accent) 35%, transparent); background: var(--op-bg); }\n      .op-item-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n\n      .op-muted { color: var(--op-muted); font-size: 12px; }\n\n      .op-preview { width: 100%; height: 90px; background: var(--op-bg); display: flex; align-items: center; justify-content: center; border: 2px dashed var(--op-border); border-radius: 8px; overflow: hidden; position: relative; cursor: pointer; }\n      .op-preview img { max-width: 100%; max-height: 100%; display: block; pointer-events: none; }\n      .op-preview.drop-highlight { background: color-mix(in oklab, var(--op-accent) 12%, transparent); }\n      .op-preview .op-drop-hint { position: absolute; bottom: 6px; right: 8px; font-size: 11px; color: var(--op-muted); pointer-events: none; }\n\n      .op-icon-btn { background: var(--op-btn); color: var(--op-text); border: 1px solid var(--op-btn-border); border-radius: 8px; width: 34px; height: 34px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }\n      .op-icon-btn:hover { background: var(--op-btn-hover); }\n\n      .op-danger { background: #fee2e2; border-color: #fecaca; color: #7f1d1d; }\n      .op-danger-text { color: #dc2626; font-weight: 600; }\n\n      .op-toast-stack { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: none; z-index: 999999; width: min(92vw, 480px); }\n      .op-toast { background: var(--op-bg); border: 1px solid var(--op-border); color: var(--op-text); padding: 8px 16px; border-radius: 8px; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); opacity: 0; transform: translateY(-8px); transition: opacity .2s ease, transform .2s ease; max-width: 100%; text-align: center; }\n      .op-toast.show { opacity: 1; transform: translateY(0); }\n      .op-toast-stack.op-dark .op-toast { background: var(--op-bg); border-color: var(--op-border); color: var(--op-text); }\n\n      /* Color Match Modal */\n      .op-cc-backdrop { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.45); display: none; }\n      .op-cc-backdrop.show { display: block; }\n\n      .op-cc-modal {\n        position: fixed; z-index: 10001;\n        width: min(1280px, 98vw);\n        max-height: 92vh;\n        left: 50%; top: 50%; transform: translate(-50%, -50%);\n        background: var(--op-bg); color: var(--op-text);\n        border: 1px solid var(--op-border);\n        border-radius: 14px;\n        box-shadow: 0 16px 48px rgba(0,0,0,0.28);\n        display: none; flex-direction: column;\n      }\n      .op-cc-header { padding: 10px 12px; border-bottom: 1px solid var(--op-border); display: flex; align-items: center; justify-content: space-between; user-select: none; cursor: default; }\n      .op-cc-title { font-weight: 600; }\n      .op-cc-close { border: 1px solid var(--op-btn-border); background: var(--op-btn); border-radius: 8px; padding: 4px 8px; cursor: pointer; }\n      .op-cc-close:hover { background: var(--op-btn); }\n      .op-cc-pill { border-radius: 999px; padding: 4px 10px; border: 1px solid var(--op-border); background: var(--op-bg); }\n\n      .op-cc-body {\n        display: grid;\n        grid-template-columns: 2fr 420px;\n        grid-template-areas: \"preview controls\";\n        gap: 12px;\n        padding: 12px;\n        overflow: hidden;\n      }\n      @media (max-width: 860px) {\n        .op-cc-body { grid-template-columns: 1fr; grid-template-areas: \"preview\" \"controls\"; max-height: calc(92vh - 100px); overflow: auto; }\n      }\n\n      .op-cc-preview-wrap { grid-area: preview; background: var(--op-subtle); border: 1px solid var(--op-border); border-radius: 10px; position: relative; min-height: 320px; display: flex; align-items: center; justify-content: center; overflow: auto; }\n      .op-cc-canvas { image-rendering: pixelated; }\n      .op-cc-zoom { position: absolute; top: 8px; right: 8px; display: inline-flex; gap: 6px; }\n      .op-cc-zoom .op-icon-btn { width: 34px; height: 34px; }\n\n      .op-cc-controls { grid-area: controls; display: flex; flex-direction: column; gap: 12px; background: var(--op-subtle); border: 1px solid var(--op-border); border-radius: 10px; padding: 10px; overflow: auto; max-height: calc(92vh - 160px); }\n      .op-cc-block { display: flex; flex-direction: column; gap: 6px; }\n      .op-cc-block label { color: var(--op-muted); font-weight: 600; }\n\n      .op-cc-palette { display: flex; flex-direction: column; gap: 8px; background: var(--op-bg); border: 1px solid var(--op-border); border-radius: 8px; padding: 8px; }\n      .op-list-subtle { background: var(--op-bg); border: 1px solid var(--op-border); border-radius: 8px; padding: 6px; }\n      .op-cc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(22px, 22px)); gap: 6px; }\n      .op-cc-cell { width: 22px; height: 22px; border-radius: 4px; border: 2px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,0.15) inset; cursor: pointer; }\n      .op-cc-cell.active { outline: 2px solid var(--op-accent); }\n\n      .op-cc-footer { padding: 10px 12px; border-top: 1px solid var(--op-border); display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; }\n      .op-cc-actions { display: inline-flex; gap: 8px; }\n      .op-cc-ghost { color: var(--op-muted); font-size: 12px; }\n\n      .op-color-list-item { display: flex; align-items: center; gap: 8px; font-size: 12px; padding: 2px 4px; }\n      .op-color-list-swatch { width: 14px; height: 14px; border-radius: 4px; border: 1px solid var(--op-border); flex-shrink: 0; }\n      .op-color-list-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\n      .op-color-list-count { font-weight: 600; }\n      .op-color-list-item.premium .op-color-list-name { color: #eeff00ff; font-weight: bold; }\n      .op-theme-dark .op-color-list-item.premium .op-color-list-name { color: #fdd835; }\n\n      .op-dist-item { display: flex; align-items: center; gap: 8px; font-size: 12px; padding: 2px 4px; }\n      .op-dist-item.premium .op-color-list-name { color: #eeff00ff; font-weight: bold; }\n      .op-theme-dark .op-dist-item.premium .op-color-list-name { color: #fdd835; }\n\n      /* Resize Modal */\n      .op-rs-backdrop { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.45); display: none; }\n      .op-rs-backdrop.show { display: block; }\n\n      .op-rs-modal {\n        position: fixed; z-index: 10001;\n        width: min(1200px, 96vw);\n        left: 50%; top: 50%; transform: translate(-50%, -50%);\n        background: var(--op-bg); color: var(--op-text);\n        border: 1px solid var(--op-border);\n        border-radius: 12px;\n        box-shadow: 0 12px 24px rgba(0,0,0,0.2);\n        display: none; flex-direction: column;\n        max-height: 92vh;\n      }\n      .op-rs-header { padding: 10px 12px; border-bottom: 1px solid var(--op-border); display: flex; align-items: center; justify-content: space-between; user-select: none; cursor: default; }\n      .op-rs-title { font-weight: 600; }\n      .op-rs-close { border: 1px solid var(--op-border); background: transparent; border-radius: 8px; padding: 4px 8px; cursor: pointer; }\n      .op-rs-close:hover { background: var(--op-btn); }\n\n      .op-rs-tabs { display: flex; gap: 6px; padding: 8px 12px 0 12px; }\n      .op-rs-tab-btn { background: var(--op-btn); color: var(--op-text); border: 1px solid var(--op-btn-border); border-radius: 10px; padding: 6px 10px; cursor: pointer; }\n      .op-rs-tab-btn.active { outline: 2px solid color-mix(in oklab, var(--op-accent) 35%, transparent); background: var(--op-btn-hover); }\n\n      .op-rs-body { padding: 12px; display: grid; grid-template-columns: 1fr; gap: 10px; overflow: auto; }\n      .op-rs-row { display: flex; align-items: center; gap: 8px; }\n      .op-rs-row .op-input { flex: 1; }\n\n      .op-rs-pane { display: none; }\n      .op-rs-pane.show { display: block; }\n\n      .op-rs-preview-wrap { background: var(--op-subtle); border: 1px solid var(--op-border); border-radius: 12px; position: relative; height: clamp(260px, 36vh, 540px); display: flex; align-items: center; justify-content: center; overflow: hidden; }\n      .op-rs-canvas { image-rendering: pixelated; }\n\n      .op-rs-zoom { position: absolute; top: 8px; right: 8px; display: inline-flex; gap: 6px; }\n\n      .op-rs-grid-note { color: var(--op-muted); font-size: 12px; }\n      .op-rs-mini { width: 96px; }\n\n      .op-rs-dual { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; height: 100%; padding: 8px; box-sizing: border-box; }\n      .op-rs-col { position: relative; background: var(--op-bg); border: 1px dashed var(--op-border); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; overflow: hidden; }\n      .op-rs-col .label { position: absolute; top: 2px; left: 0; right: 0; text-align: center; font-size: 12px; color: var(--op-muted); pointer-events: none; }\n      .op-rs-col .pad-top { height: 18px; width: 100%; flex: 0 0 auto; }\n      .op-rs-thumb { width: 100%; height: calc(100% - 18px); display: block; }\n\n      .op-pan-grab { cursor: grab; }\n      .op-pan-grabbing { cursor: grabbing; }\n\n      .op-rs-footer { padding: 10px 12px; border-top: 1px solid var(--op-border); display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; }\n    ",document.head.appendChild(e)}(),U(),H()};"loading"===document.readyState?window.addEventListener("DOMContentLoaded",e):e()}))}();